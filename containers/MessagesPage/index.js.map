{"version":3,"sources":["containers/MessagesPage/index.js"],"names":["MessageSpiner","spinerContainer","MessagesPage","props","onSearchChange","e","value","currentTarget","updateSearchingString","searchMessage","bind","getMessageRecipientNames","message","recipients","length","getRecipientsList","map","recipient","phoneNumber","extensionNumber","matcherContactName","matchedNames","matcherName","formatPhone","name","searchText","searchNumber","recipientName","indexOf","toLowerCase","searchString","searchingString","updateSearchResults","trim","replace","searchTextResults","searchMessagesText","reverse","searchContactresults","allMessages","filter","isMatchRecipients","results","searchMap","addSearchResultToResult","conversationId","push","forEach","searchingResults","getString","formatDateTime","messages","loadNextPageMessages","showSpinner","root","content","renderMessageList","propTypes","func","isRequired","bool","string","defaultProps","mapStateToProps","state","currentLocale","locale","messageStore","conversations","ready","contactMatcher","extensionInfo","dateTimeFormat","lastUpdatedAt","mapDispatchToProps","dispatch","matcherNames","dataMapping","matcher","join","utcTimestamp","areaCode","regionSettings","countryCode","myExtensionNumber"],"mappings":"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","file":"index.js","sourcesContent":["import React, { Component, PropTypes } from 'react';\nimport { connect } from 'react-redux';\n\nimport formatNumber from 'ringcentral-integration/lib/formatNumber';\nimport { getRecipients } from 'ringcentral-integration/lib/messageHelper';\n\nimport Spinner from '../../components/Spinner';\nimport Panel from '../../components/Panel';\n\nimport MessageList from '../../components/MessageList';\nimport SearchInput from '../../components/SearchInput';\n\nimport styles from './styles.scss';\nimport i18n from './i18n';\n\nfunction MessageSpiner() {\n  return (\n    <div className={styles.spinerContainer}>\n      <Spinner />\n    </div>\n  );\n}\n\nclass MessagesPage extends Component {\n  constructor(props) {\n    super(props);\n    this.onSearchChange = (e) => {\n      const value = e.currentTarget.value;\n      this.props.updateSearchingString(value);\n    };\n\n    this.searchMessage = this.searchMessage.bind(this);\n    this.getMessageRecipientNames = this.getMessageRecipientNames.bind(this);\n  }\n\n  getMessageRecipientNames(message) {\n    let recipients = message.recipients;\n    if (!recipients || recipients.length === 0) {\n      recipients = this.props.getRecipientsList(message);\n    }\n    return recipients.map((recipient) => {\n      const phoneNumber = recipient.phoneNumber || recipient.extensionNumber;\n      if (phoneNumber && this.props.matcherContactName) {\n        if (recipient.matchedNames && recipient.matchedNames[0]) {\n          return recipient.matchedNames[0];\n        }\n        const matcherName = this.props.matcherContactName(phoneNumber);\n        if (matcherName) {\n          return matcherName;\n        }\n        return this.props.formatPhone(phoneNumber);\n      }\n      if (recipient.name) {\n        return recipient.name;\n      }\n      return this.props.formatPhone(phoneNumber);\n    });\n  }\n\n  isMatchRecipients(message, searchText, searchNumber) {\n    const recipients = this.props.getRecipientsList(message);\n    for (const recipient of recipients) {\n      const phoneNumber = recipient.phoneNumber || recipient.extensionNumber;\n      let recipientName = null;\n      if (phoneNumber) {\n        if (searchNumber && searchNumber.length > 0 && phoneNumber.indexOf(searchNumber) >= 0) {\n          return true;\n        }\n        if (this.props.matcherContactName) {\n          const matcherName = this.props.matcherContactName(phoneNumber);\n          if (matcherName) {\n            recipientName = matcherName;\n          } else {\n            recipientName = phoneNumber;\n          }\n        }\n      }\n      if (!recipientName && recipient.name) {\n        recipientName = recipient.name;\n      }\n      if (recipientName && recipientName.toLowerCase().indexOf(searchText) >= 0) {\n        return true;\n      }\n    }\n    return false;\n  }\n\n  searchMessage() {\n    const searchString = this.props.searchingString;\n    if (searchString.length < 3) {\n      this.props.updateSearchResults([]);\n      return;\n    }\n    const searchText = searchString.toLowerCase().trim();\n    let searchNumber = searchString.replace(/[^\\d]/g, '');\n    if (searchString.length !== searchNumber.length && searchNumber.length < 2) {\n      searchNumber = null;\n    }\n    const searchTextResults = this.props.searchMessagesText(searchText).reverse();\n    const searchContactresults = this.props.allMessages.filter(message =>\n      this.isMatchRecipients(message, searchText, searchNumber)\n    ).reverse();\n    const results = [];\n    const searchMap = {};\n    const addSearchResultToResult = (message) => {\n      if (searchMap[message.conversationId]) {\n        return;\n      }\n      searchMap[message.conversationId] = 1;\n      results.push(message);\n    };\n    searchContactresults.forEach(addSearchResultToResult);\n    searchTextResults.forEach(addSearchResultToResult);\n    this.props.updateSearchResults(results);\n  }\n\n  renderMessageList() {\n    if (this.props.searchingString.length >= 3) {\n      return (\n        <MessageList\n          messages={this.props.searchingResults}\n          loadNextPageMessages={() => null}\n          loading={false}\n          placeholder={i18n.getString('noSearchResults')}\n          formatDateTime={this.props.formatDateTime}\n          getMessageRecipientNames={this.getMessageRecipientNames}\n        />\n      );\n    }\n    return (\n      <MessageList\n        messages={this.props.messages}\n        loadNextPageMessages={this.props.loadNextPageMessages}\n        placeholder={i18n.getString('noMessages')}\n        formatDateTime={this.props.formatDateTime}\n        getMessageRecipientNames={this.getMessageRecipientNames}\n      />\n    );\n  }\n\n  render() {\n    const showSpinner = this.props.showSpinner;\n    if (showSpinner) {\n      return (\n        <div className={styles.root}>\n          <MessageSpiner />\n        </div>\n      );\n    }\n    return (\n      <div className={styles.content}>\n        <SearchInput\n          value={this.props.searchingString}\n          onChange={this.onSearchChange}\n          onKeyUp={this.searchMessage}\n          maxLength={30}\n          placeholder={i18n.getString('search')}\n        />\n        <Panel>\n          {this.renderMessageList()}\n        </Panel>\n      </div>\n    );\n  }\n}\n\nMessagesPage.propTypes = {\n  messages: MessageList.propTypes.messages,\n  allMessages: MessageList.propTypes.messages,\n  searchingResults: MessageList.propTypes.messages,\n  loadNextPageMessages: PropTypes.func.isRequired,\n  updateSearchingString: PropTypes.func.isRequired,\n  showSpinner: PropTypes.bool.isRequired,\n  searchingString: PropTypes.string.isRequired,\n  formatDateTime: PropTypes.func.isRequired,\n  formatPhone: PropTypes.func.isRequired,\n  getRecipientsList: PropTypes.func.isRequired,\n  searchMessagesText: PropTypes.func.isRequired,\n  updateSearchResults: PropTypes.func.isRequired,\n  matcherContactName: PropTypes.func,\n};\n\nMessagesPage.defaultProps = {\n  matcherContactName: null,\n};\n\nfunction mapStateToProps(state, props) {\n  return ({\n    currentLocale: props.locale.currentLocale,\n    messages: props.messages.messages,\n    allMessages: props.messageStore.conversations,\n    showSpinner: (\n      !props.messages.ready ||\n      (props.contactMatcher && !props.contactMatcher.ready) ||\n      !props.extensionInfo.ready ||\n      !props.dateTimeFormat.ready\n    ),\n    lastUpdatedAt: props.messages.lastUpdatedAt,\n    searchingString: props.messages.searchingString,\n    searchingResults: props.messages.searchingResults,\n  });\n}\n\nfunction mapDispatchToProps(dispatch, props) {\n  let matcherContactName = null;\n  if (props.contactMatcher && props.contactMatcher.ready) {\n    matcherContactName = (phoneNumber) => {\n      const matcherNames = props.contactMatcher.dataMapping[phoneNumber];\n      if (matcherNames && matcherNames.length > 0) {\n        return matcherNames.map(matcher => matcher.name).join('&');\n      }\n      return null;\n    };\n  }\n  return {\n    loadNextPageMessages: props.messages.loadNextPageMessages,\n    updateSearchingString: props.messages.updateSearchingString,\n    updateSearchResults: props.messages.updateSearchResults,\n    formatDateTime: props.formatDateTime ||\n    (utcTimestamp => props.dateTimeFormat.formatDateTime({\n      utcTimestamp\n    })),\n    formatPhone: phoneNumber => formatNumber({\n      phoneNumber,\n      areaCode: props.regionSettings.areaCode,\n      countryCode: props.regionSettings.countryCode,\n    }),\n    getRecipientsList: message => getRecipients({\n      message,\n      myExtensionNumber: props.extensionInfo.extensionNumber,\n    }),\n    searchMessagesText: searchText =>\n      props.messageStore.searchMessagesText(searchText),\n    matcherContactName,\n  };\n}\n\nexport default connect(mapStateToProps, mapDispatchToProps)(MessagesPage);\n"]}