{"version":3,"sources":["modules/ConferenceCall/index.js"],"names":["DEFAULT_TIMEOUT","DEFAULT_TTL","MAXIMUM_CAPACITY","_fromSessionId","_lastCallInfo","ascendSortParties","parties","filter","party","conferenceRole","toLowerCase","host","sort","last","next","id","split","ConferenceCall","deps","dep","optional","auth","alert","call","callingSettings","client","rolesAndPermissions","contactMatcher","webphone","connectivityMonitor","pulling","capacity","timeout","options","actionTypes","_auth","ensureExist","_alert","_call","_callingSettings","_client","_webphone","_connectivityMonitor","_contactMatcher","_rolesAndPermissions","_reducer","_ttl","_timout","_timers","_pulling","sessionId","res","findConferenceWithSession","isMerging","session","sessions","find","conferences","c","store","dispatch","type","updateConference","conference","state","service","platform","get","rawResponse","response","json","storedconference","updateConferenceSucceeded","updateConferenceFailed","message","toString","terminateConference","conferenceData","hangup","delete","terminateConferenceSucceeded","terminateConferenceFailed","warning","conferenceErrors","webphoneSession","propagete","conferenceState","ready","isOverload","connectivity","danger","modeError","ttl","bringInConference","_getProfile","partyProfile","post","partyData","updateConferenceStatus","newConference","newParties","length","bringInConferenceSucceeded","bringInConferenceFailed","partyId","removeFromConference","removeFromConferenceSucceeded","removeFromConferenceFailed","propagate","_checkPermission","permissionsMessages","insufficientPrivilege","callingMode","callingModes","_makeConference","subscribe","_onStateChange","webphoneSessions","isConferenceSession","bringInFailed","mergeStart","sipInstances","conferenceId","map","_sessions","sessionIds","x","setSessionCaching","pSips","instance","p","resolve","on","all","_mergeToConference","then","mergeSucceeded","emit","profiles","mergeFailed","clearSessionCaching","fromSessionId","toSessionId","updateFromSession","updateToSession","mergingPair","closeMergingPair","reduce","accum","idx","status","code","partyStatusCode","disconnected","push","i","getOnlineParties","Array","isArray","countOnlineParties","setTimeout","stopPollingConferenceStatus","startPollingConferenceStatus","clearTimeout","Error","func","isOnce","once","off","updateCurrentConferenceId","initSuccess","_shouldInit","_init","_shouldReset","_reset","resetSuccess","loggedIn","pending","hasConferenceCallPermission","forEach","evt","bringInToConference","makeConference","confereceAccepted","race","reject","sipSession","phoneNumber","voiceCallToken","isConference","Object","prototype","_hookConference","makeConferenceSucceeded","makeConferenceFailed","to","contactMatch","from","fromNumber","direction","toUserName","avatarUrl","rcId","partyNumber","calleeType","calleeTypes","contacts","callDirections","outbound","match","queries","ignoreCache","dataMapping","contactMapping","contact","nameMatches","profileImageUrl","name","unknow","sessionIdToMergeWith","onReadyToMerge","sessionToMergeWith","isCallRecording","conferenceSession","setMergeParty","mergeToConference","resume","currentConferenceSession","isCurrentConferenceOnhold","isOnHold","participantListClickHangupTrack","removeParticipantClickCancelTrack","removeParticipantClickRemoveTrack","conferenceCallStatus","currentConferenceId","RcModule","proxify","getter","partyProfiles","lastCall","toMatches","lastCalleeType","sessionStatus","finished","partiesAvatarUrls","profile","extraNum","callStatus","lastCallContact","getOnlinePartyProfiles"],"mappings":"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","file":"index.js","sourcesContent":["import { find } from 'ramda';\nimport EventEmitter from 'event-emitter';\nimport { createSelector } from 'reselect';\nimport getter from '../../lib/getter';\nimport { Module } from '../../lib/di';\nimport callDirections from '../../enums/callDirections';\nimport RcModule from '../../lib/RcModule';\nimport actionTypes from './actionTypes';\nimport partyStatusCode from './partyStatusCode';\nimport conferenceRole from './conferenceRole';\nimport getConferenceCallReducer from './getConferenceCallReducer';\nimport proxify from '../../lib/proxy/proxify';\nimport permissionsMessages from '../RolesAndPermissions/permissionsMessages';\nimport conferenceErrors from './conferenceCallErrors';\nimport { isConferenceSession } from '../Webphone/webphoneHelper';\n// import webphoneErrors from '../Webphone/webphoneErrors';\nimport ensureExist from '../../lib/ensureExist';\n// import sleep from '../../lib/sleep';\nimport callingModes from '../CallingSettings/callingModes';\nimport calleeTypes from '../../enums/calleeTypes';\nimport { isFunction } from '../../lib/di/utils/is_type';\nimport sessionStatus from '../Webphone/sessionStatus';\n\nconst DEFAULT_TIMEOUT = 30000;// time out for conferencing session being accepted.\nconst DEFAULT_TTL = 5000;// timer to update the conference information\nconst MAXIMUM_CAPACITY = 10;\n\nlet _fromSessionId;\nlet _lastCallInfo;\n\nfunction ascendSortParties(parties) {\n  return parties\n    .filter(party => party.conferenceRole.toLowerCase() !== conferenceRole.host)\n    .sort((last, next) => +last.id.split('-')[1] - (+next.id.split('-')[1]));\n}\n\n/**\n * @class\n * @description ConferenceCall managing module\n */\n@Module({\n  deps: [\n    'Auth',\n    'Alert',\n    'Call',\n    'CallingSettings',\n    'ConnectivityMonitor',\n    'Client',\n    'Webphone',\n    'RolesAndPermissions',\n    {\n      dep: 'ContactMatcher',\n      optional: true\n    },\n    {\n      dep: 'Webphone',\n      optional: true\n    },\n    {\n      dep: 'ConferenceCallOptions',\n      optional: true\n    },\n  ]\n})\n\nexport default class ConferenceCall extends RcModule {\n  /**\n   * @constructor\n   * @param {Object} params - params object\n   * @param {RegionSettings} params.regionSettings - regionSettings module instance\n   * @param {Client} params.client - client module instance\n   */\n  constructor({\n    auth,\n    alert,\n    call,\n    callingSettings,\n    client,\n    rolesAndPermissions,\n    contactMatcher,\n    webphone,\n    connectivityMonitor,\n    pulling = true,\n    capacity = MAXIMUM_CAPACITY,\n    timeout = DEFAULT_TIMEOUT,\n    ...options\n  }) {\n    super({\n      ...options,\n      actionTypes,\n    });\n    this._auth = this::ensureExist(auth, 'auth');\n    this._alert = this::ensureExist(alert, 'alert');\n    this._call = this::ensureExist(call, 'call');\n    this._callingSettings = this::ensureExist(callingSettings, 'callingSettings');\n    this._client = this::ensureExist(client, 'client');\n    // in order to run the integeration test, we need it to be optional\n    this._webphone = webphone;\n    this._connectivityMonitor = connectivityMonitor;\n    this._contactMatcher = contactMatcher;\n    this._rolesAndPermissions = this::ensureExist(rolesAndPermissions, 'rolesAndPermissions');\n    // we need the constructed actions\n    this._reducer = getConferenceCallReducer(this.actionTypes);\n    this._ttl = DEFAULT_TTL;\n    this._timout = timeout;\n    this._timers = {};\n    this._pulling = pulling;\n    this.capacity = capacity;\n  }\n\n  isConferenceSession(sessionId) {\n    // only can be used after webphone._onCallStartFunc\n    let res = !!this.findConferenceWithSession(sessionId);\n\n    if (this.isMerging && !res) {\n      const session = this._webphone.sessions.find(session => session.id === sessionId);\n      res = isConferenceSession(session);\n    }\n\n    return res;\n  }\n\n  findConferenceWithSession(sessionId) {\n    return Object.values(this.conferences).find(c => c.sessionId === sessionId);\n  }\n\n  /**\n   *\n   * @param {string} id: conference id\n   */\n  @proxify\n  async updateConferenceStatus(id) {\n    this.store.dispatch({\n      type: this.actionTypes.updateConference,\n      conference: this.state.conferences[id],\n    });\n    try {\n      const rawResponse = await this._client.service.platform()\n        .get(`/account/~/telephony/sessions/${id}`);\n      const response = rawResponse.json();\n      const storedconference = this.state.conferences[response.id];\n      const conference = Object.assign({}, storedconference.conference);\n      conference.parties = response.parties;\n      const {\n        sessionId\n      } = storedconference;\n      this.store.dispatch({\n        type: this.actionTypes.updateConferenceSucceeded,\n        conference,\n        sessionId,\n      });\n    } catch (e) {\n    // TODO: alert\n      this.store.dispatch({\n        type: this.actionTypes.updateConferenceFailed,\n        conference: this.state.conferences[id],\n        message: e.toString()\n      });\n      // need to propagate to out side try...catch block\n      throw e;\n    } finally {\n      // eslint-disable-next-line no-unsafe-finally\n      return this.state.conferences[id];\n    }\n  }\n\n  /**\n   * terminate a conference.\n   * @param {string} id: conference id\n   */\n  @proxify\n  async terminateConference(id) {\n    this.store.dispatch({\n      type: this.actionTypes.terminateConference,\n      conference: this.state.conferences[id],\n    });\n    const conferenceData = this.conferences[id];\n\n    try {\n      if (this._webphone) {\n        if (conferenceData) {\n          this._webphone.hangup(conferenceData.sessionId);\n          // Help server to do the GC, and we don't care the whether it's successful or not\n          this._client.service.platform()\n            .delete(`/account/~/telephony/sessions/${id}`);\n          this.store.dispatch({\n            type: this.actionTypes.terminateConferenceSucceeded,\n            conference: conferenceData.conference,\n          });\n        } else {\n          this.store.dispatch({\n            type: this.actionTypes.terminateConferenceFailed,\n          });\n        }\n      } else {\n        await this._client.service.platform()\n          .delete(`/account/~/telephony/sessions/${id}`);\n        this.store.dispatch({\n          type: this.actionTypes.terminateConferenceSucceeded,\n          conference: conferenceData.conference,\n        });\n      }\n    } catch (e) {\n      this._alert.warning({\n        message: conferenceErrors.terminateConferenceFailed,\n      });\n      this.store.dispatch({\n        type: this.actionTypes.terminateConferenceFailed,\n        message: e.toString()\n      });\n    } finally {\n      // eslint-disable-next-line no-unsafe-finally\n      return conferenceData;\n    }\n  }\n\n  /**\n   * Bring-in an outbound call into conference.\n   * @param {string} id: conference id\n   * @param {webphone.session} webphoneSession: get it from callMonitor.\\w+Calls[\\d+]\n   * interface SessionData{\n   *  \"party-id\": String,\n   *  \"session-id\": String\n   * }\n   */\n  @proxify\n  async bringInToConference(id, webphoneSession, propagete = false) {\n    const conferenceState = this.state.conferences[id];\n    if (\n      !conferenceState\n      || !this.ready\n      || !webphoneSession\n      || this.isOverload(id)\n      || !this._connectivityMonitor.connectivity\n    ) {\n      this._alert.danger({\n        message: conferenceErrors.modeError,\n        ttl: 0,\n      });\n      return null;\n    }\n    const { sessionId } = conferenceState;\n    let { conference } = conferenceState;\n\n    this.store.dispatch({\n      type: this.actionTypes.bringInConference,\n      conference,\n      sessionId,\n    });\n\n    try {\n      const partyProfile = await this._getProfile(webphoneSession.id);\n      await this._client.service.platform()\n        .post(`/account/~/telephony/sessions/${id}/parties/bring-in`, webphoneSession.partyData);\n      const newConference = await this.updateConferenceStatus(id);\n      conference = newConference.conference;\n\n      if (partyProfile) {\n        const conferenceState = this.state.conferences[id];\n        const newParties = ascendSortParties(conferenceState.conference.parties);\n        partyProfile.id = newParties[newParties.length - 1].id;\n      }\n\n      this.store.dispatch({\n        type: this.actionTypes.bringInConferenceSucceeded,\n        conference,\n        sessionId,\n        partyProfile,\n      });\n\n      return id;\n    } catch (e) {\n      this.store.dispatch({\n        type: this.actionTypes.bringInConferenceFailed,\n        message: e.toString()\n      });\n      if (!propagete) {\n        return null;\n      }\n      throw e;\n    }\n  }\n\n  /**\n   * remove a participant from conference.\n   * @param {string} id: conference id\n   * @param {SessionData} partyId: one participant's id of an conference's `parties` list\n   */\n  @proxify\n  async removeFromConference(id, partyId) {\n    this.store.dispatch({\n      type: this.actionTypes.removeFromConference,\n      conference: this.state.conferences[id],\n    });\n\n    try {\n      await this._client.service.platform()\n        .delete(`/account/~/telephony/sessions/${id}/parties/${partyId}`);\n      await this.updateConferenceStatus(id);\n      this.store.dispatch({\n        type: this.actionTypes.removeFromConferenceSucceeded,\n        conference: this.state.conferences[id],\n      });\n    } catch (e) {\n      this._alert.warning({\n        message: conferenceErrors.removeFromConferenceFailed,\n      });\n      this.store.dispatch({\n        type: this.actionTypes.removeFromConferenceFailed,\n        message: e.toString()\n      });\n    } finally {\n      // eslint-disable-next-line no-unsafe-finally\n      return this.state.conferences[id];\n    }\n  }\n\n  /**\n   * start a conference call, return the session\n   */\n  @proxify\n  async makeConference(propagate = false) {\n    if (!this.ready || !this._connectivityMonitor.connectivity) {\n      this._alert.danger({\n        message: conferenceErrors.modeError,\n        ttl: 0,\n      });\n      return null;\n    }\n    if (!this._checkPermission()) {\n      if (!propagate) {\n        this._alert.danger({\n          message: permissionsMessages.insufficientPrivilege,\n          ttl: 0,\n        });\n      }\n\n      return null;\n    }\n    if (!this._callingSettings.callingMode === callingModes.webphone) {\n      if (!propagate) {\n        this._alert.danger({\n          message: conferenceErrors.modeError,\n          ttl: 0,\n        });\n      }\n\n      return null;\n    }\n    const conference = await this._makeConference(propagate);\n    return conference;\n  }\n\n  initialize() {\n    this.store.subscribe(() => this._onStateChange());\n  }\n\n  /**\n   * Merge calls to (or create) a conference.\n   * @param {webphone.sessions} webphoneSessions\n   * FIXME: dynamically construct this function during the construction\n   * to avoid `this._webphone` criterias to improve performance ahead of time\n   */\n  @proxify\n  async mergeToConference(webphoneSessions = []) {\n    webphoneSessions = webphoneSessions\n      .filter(session => !!session)\n      .filter(session => !this.isConferenceSession(session.id));\n\n    if (!webphoneSessions.length) {\n      this._alert.warning({\n        message: conferenceErrors.bringInFailed,\n      });\n      return;\n    }\n\n    this.store.dispatch({\n      type: this.actionTypes.mergeStart,\n    });\n    let sipInstances;\n    let conferenceId = null;\n\n    if (this._webphone) {\n      /**\n       * Because the concurrency behaviour of the server,\n       * we cannot sure the merging process is over when\n       * the function's procedure has finshed.\n       */\n      sipInstances = webphoneSessions\n        .map(webphoneSession => this._webphone._sessions.get(webphoneSession.id));\n      /**\n       * HACK: we need to preserve the merging session in prevent the glitch of\n       * the call control page.\n       */\n      const sessionIds = webphoneSessions.map(x => x.id);\n      this._webphone.setSessionCaching(sessionIds);\n\n      const pSips = sipInstances.map((instance) => {\n        const p = new Promise((resolve) => {\n          instance.on('terminated', () => {\n            resolve();\n          });\n        });\n        return p;\n      });\n\n      await Promise.all([this._mergeToConference(webphoneSessions), ...pSips])\n        .then(() => {\n          this.store.dispatch({\n            type: this.actionTypes.mergeSucceeded,\n          });\n          const conferenceState = Object.values(this.conferences)[0];\n\n          this.emit(this.actionTypes.mergeSucceeded, conferenceState);\n        }, () => {\n          const conferenceState = Object.values(this.conferences)[0];\n\n          /**\n           * if create conference successfully but failed to bring-in,\n           *  then terminate the conference.\n           */\n          if (conferenceState && conferenceState.profiles.length < 1) {\n            this.terminateConference(conferenceState.conference.id);\n          }\n          this._alert.warning({\n            message: conferenceErrors.bringInFailed,\n          });\n          this.store.dispatch({\n            type: this.actionTypes.mergeFailed,\n          });\n        });\n      this._webphone.clearSessionCaching();\n    } else {\n      try {\n        conferenceId = await this._mergeToConference(webphoneSessions);\n\n        this.store.dispatch({\n          type: this.actionTypes.mergeSucceeded,\n        });\n        this.emit(this.actionTypes.mergeSucceeded);\n      } catch (e) {\n        const conferenceState = Object.values(this.conferences)[0];\n        /**\n         * if create conference successfully but failed to bring-in,\n         *  then terminate the conference.\n         */\n        if (conferenceState && conferenceState.conference.parties.length < 1) {\n          this.terminateConference(conferenceState.conference.id);\n        }\n        this._alert.warning({\n          message: conferenceErrors.bringInFailed,\n        });\n      }\n      if (!sipInstances || conferenceId === null) {\n        this.store.dispatch({\n          type: this.actionTypes.mergeFailed,\n        });\n      }\n    }\n  }\n\n  @proxify\n  setMergeParty({ fromSessionId, toSessionId }) {\n    if (fromSessionId) {\n      this.store.dispatch({\n        type: this.actionTypes.updateFromSession,\n        fromSessionId,\n      });\n      return;\n    }\n    this.store.dispatch({\n      type: this.actionTypes.updateToSession,\n      toSessionId,\n    });\n  }\n\n  /**\n   * we need to remove the fromSessionId in mergingPair when the outbound call is hang-up\n   */\n  @proxify\n  closeMergingPair() {\n    if (this.mergingPair.fromSessionId) {\n      return this.store.dispatch({\n        type: this.actionTypes.closeMergingPair,\n      });\n    }\n\n    return null;\n  }\n\n  getOnlinePartyProfiles(id) {\n    const conferenceData = this.conferences[id];\n\n    if (conferenceData) {\n      return ascendSortParties(conferenceData.conference.parties)\n        .reduce((accum, party, idx) => {\n          if (party.status.code.toLowerCase() !== partyStatusCode.disconnected) {\n            // 0 position is the host\n            accum.push({ idx, party });\n          }\n          return accum;\n        }, [])\n        .map(({ idx, party }) => ({ ...party, ...conferenceData.profiles[idx] }))\n        .filter(i => !!i);\n    }\n    return null;\n  }\n\n  getOnlineParties(id) {\n    const conferenceData = this.conferences[id];\n    if (conferenceData) {\n      return conferenceData.conference.parties.filter(\n        p => p.status.code.toLowerCase() !== partyStatusCode.disconnected\n      );\n    }\n    return null;\n  }\n\n  countOnlineParties(id) {\n    const res = this.getOnlineParties(id);\n    return Array.isArray(res) ? res.length : null;\n  }\n\n  isOverload(id) {\n    return this.countOnlineParties(id) >= this.capacity;\n  }\n\n  @proxify\n  async startPollingConferenceStatus(id) {\n    if (this._timers[id] || !this._pulling) {\n      return;\n    }\n\n    await this.updateConferenceStatus(id);\n    this._timers[id] = setTimeout(\n      async () => {\n        await this.updateConferenceStatus(id);\n        this.stopPollingConferenceStatus(id);\n        if (this.conferences[id]) {\n          this.startPollingConferenceStatus(id);\n        }\n      },\n      this._ttl);\n  }\n\n  stopPollingConferenceStatus(id) {\n    clearTimeout(this._timers[id]);\n    delete this._timers[id];\n  }\n\n  openPulling() {\n    this._pulling = true;\n  }\n\n  closePulling() {\n    this._pulling = false;\n  }\n\n  togglePulling() {\n    this._pulling = !this.pulling;\n  }\n\n  setCapatity(capacity = MAXIMUM_CAPACITY) {\n    if (typeof capacity !== 'number') {\n      throw new Error('The capcity must be a number');\n    }\n    this.capacity = capacity;\n    return capacity;\n  }\n\n  setTimeout(timeout = DEFAULT_TIMEOUT) {\n    if (typeof timeout !== 'number') {\n      throw new Error('The timeout must be a number');\n    }\n    this._timout = timeout;\n    return timeout;\n  }\n\n  onMergeSuccess(func, isOnce) {\n    if (isOnce) {\n      this.once(this.actionTypes.mergeSucceeded, func);\n      return;\n    }\n    this.on(this.actionTypes.mergeSucceeded, func);\n  }\n\n  removeMergeSuccess(func) {\n    this.off(this.actionTypes.mergeSucceeded, func);\n  }\n\n  @proxify\n  loadConference(conferenceId) {\n    return this.store.dispatch({\n      type: this.actionTypes.updateCurrentConferenceId,\n      conferenceId,\n    });\n  }\n\n  _init() {\n    this.store.dispatch({\n      type: this.actionTypes.initSuccess\n    });\n  }\n\n  async _onStateChange() {\n    if (this._shouldInit()) {\n      this._init();\n    } else if (this._shouldReset()) {\n      this._reset();\n    }\n  }\n\n  _reset() {\n    this.store.dispatch({\n      type: this.actionTypes.resetSuccess\n    });\n  }\n\n  _shouldInit() {\n    return (\n      (this._auth.loggedIn && this._auth.ready) &&\n      this._alert.ready &&\n      this._callingSettings.ready &&\n      this._call.ready &&\n      this._rolesAndPermissions.ready &&\n      this._connectivityMonitor.ready &&\n      this.pending\n    );\n  }\n\n  _shouldReset() {\n    return (\n      (\n        (!this._auth.loggedIn || !this._auth.ready)\n        || !this._alert.ready\n        || !this._callingSettings.ready\n        || !this._call.ready\n        || !this._rolesAndPermissions.ready\n        || !this._connectivityMonitor.ready\n      ) &&\n      this.ready\n    );\n  }\n\n  _checkPermission() {\n    if (!this._rolesAndPermissions.hasConferenceCallPermission) {\n      this._alert.danger({\n        message: permissionsMessages.insufficientPrivilege,\n        ttl: 0,\n      });\n      return false;\n    }\n    return true;\n  }\n\n  @proxify\n  _hookConference(conference, session) {\n    ['accepted'].forEach(\n      evt => session.on(\n        evt,\n        () => this.startPollingConferenceStatus(conference.id)\n      )\n    );\n    ['terminated', 'failed', 'rejected'].forEach(\n      evt => session.on(evt, () => {\n        this.store.dispatch({\n          type: this.actionTypes.terminateConferenceSucceeded,\n          conference,\n        });\n        this.stopPollingConferenceStatus(conference.id);\n      })\n    );\n  }\n\n  @proxify\n  async _mergeToConference(webphoneSessions = []) {\n    const conferenceState = Object.values(this.conferences)[0];\n    if (conferenceState) {\n      const conferenceId = conferenceState.conference.id;\n      this.stopPollingConferenceStatus(conferenceId);\n      // for the sake of participants ordering, we can't concurrently bring in the participants\n      for (const webphoneSession of webphoneSessions) {\n        await this.bringInToConference(conferenceId, webphoneSession, true);\n      }\n      if (!this.conferences[conferenceId].profiles.length) {\n        throw new Error('bring-in operations failed, not all intended parties were brought in');\n      }\n      this.startPollingConferenceStatus(conferenceId);\n      return conferenceId;\n    }\n    const { id } = await this.makeConference(true);\n    let confereceAccepted = false;\n    await Promise.race([\n      new Promise((resolve, reject) => {\n        const sipSession = this._webphone._sessions.get(this.conferences[id].sessionId);\n        sipSession.on('accepted', () => {\n          confereceAccepted = true;\n          resolve();\n        });\n        sipSession.on('cancel', () => reject(new Error('conferecing cancel')));\n        sipSession.on('failed', () => reject(new Error('conferecing failed')));\n        sipSession.on('rejected', () => reject(new Error('conferecing rejected')));\n        sipSession.on('terminated', () => reject(new Error('conferecing terminated')));\n      }),\n      new Promise((resolve, reject) => {\n        setTimeout(() => (\n          confereceAccepted ? resolve() : reject(new Error('conferecing timeout')))\n          , this._timout);\n      })\n    ]);\n    await this._mergeToConference(webphoneSessions);\n    return id;\n  }\n\n  @proxify\n  async _makeConference(propagate = false) {\n    try {\n      this.store.dispatch({\n        type: this.actionTypes.makeConference,\n      });\n\n      // TODO: replace with SDK function chaining calls\n      const rawResponse = await this._client.service.platform()\n        .post('/account/~/telephony/conference', {});\n      const response = rawResponse.json();\n      const conference = response.session;\n      const phoneNumber = conference.voiceCallToken;\n      // whether to mutate the session to mark the conference?\n      const session = await this._call.call({\n        phoneNumber,\n        isConference: true,\n      });\n      if (typeof session === 'object' &&\n        Object.prototype.toString.call(session.on).toLowerCase() === '[object function]') {\n        this._hookConference(conference, session);\n\n        this.store.dispatch({\n          type: this.actionTypes.makeConferenceSucceeded,\n          conference,\n          sessionId: session.id,\n          parties: [],\n        });\n      } else {\n        this.store.dispatch({\n          type: this.actionTypes.makeConferenceFailed,\n        });\n      }\n      return conference;\n    } catch (e) {\n      this.store.dispatch({\n        type: this.actionTypes.makeConferenceFailed,\n        message: e.toString()\n      });\n\n      if (!propagate) {\n        this._alert.warning({\n          message: conferenceErrors.makeConferenceFailed,\n        });\n        return null;\n      }\n      // need to propagate to out side try...catch block\n      throw e;\n    }\n  }\n\n  @proxify\n  async _getProfile(sessionId) {\n    if (!this._contactMatcher) {\n      return null;\n    }\n    const session = this._webphone.sessions.find(session => session.id === sessionId);\n    const {\n      to, contactMatch, from, fromNumber, direction\n    } = session;\n\n    let { toUserName } = session;\n    let avatarUrl;\n    let rcId;\n    let partyNumber;\n    let calleeType = calleeTypes.contacts;\n\n    if (direction === callDirections.outbound) {\n      partyNumber = to;\n    } else {\n      partyNumber = fromNumber;\n    }\n\n    // HACK: refresh the cache\n    await this._contactMatcher.match({\n      queries: [partyNumber],\n      ignoreCache: true\n    });\n\n    if (this._contactMatcher && this._contactMatcher.dataMapping) {\n      const contactMapping = this._contactMatcher.dataMapping;\n      let contact = contactMatch;\n      let nameMatches;\n\n      if (direction === callDirections.outbound) {\n        nameMatches = (contactMapping && contactMapping[to]) || [];\n      } else {\n        nameMatches = (contactMapping && contactMapping[from]) || [];\n      }\n\n      if (!contact) {\n        contact = nameMatches && nameMatches[0];\n      }\n      if (contact) {\n        avatarUrl = contact.profileImageUrl;\n        toUserName = contact.name;\n        rcId = contact.id;\n      } else {\n        calleeType = calleeTypes.unknow;\n      }\n    }\n\n    return {\n      avatarUrl,\n      toUserName,\n      partyNumber,\n      rcId,\n      calleeType,\n    };\n  }\n\n  @proxify\n  async mergeSession({ sessionId, sessionIdToMergeWith, onReadyToMerge }) {\n    const session = find(\n      x => x.id === sessionId,\n      this._webphone.sessions\n    );\n\n    const sessionToMergeWith = find(\n      x => x.id === (sessionIdToMergeWith || this.mergingPair.fromSessionId),\n      this._webphone.sessions\n    );\n\n    const webphoneSessions = sessionToMergeWith\n      ? [sessionToMergeWith, session]\n      : [session];\n\n    for (const session of webphoneSessions) {\n      if (this._webphone.isCallRecording({ session })) {\n        return null;\n      }\n    }\n\n    const conferenceState = Object.values(this.conferences)[0];\n    if (conferenceState) {\n      const conferenceSession = find(\n        x => x.id === conferenceState.sessionId,\n        this._webphone.sessions\n      );\n      if (this._webphone.isCallRecording({ session: conferenceSession })) {\n        return null;\n      }\n    }\n\n    if (\n      onReadyToMerge\n      && isFunction(onReadyToMerge)\n    ) {\n      onReadyToMerge();\n    }\n\n    this.setMergeParty({\n      toSessionId: sessionId,\n    });\n\n    await this.mergeToConference(webphoneSessions);\n\n    const conferenceData = Object.values(this.conferences)[0];\n    if (!conferenceData) {\n      await this._webphone.resume(session.id);\n      return null;\n    }\n    const currentConferenceSession = find(\n      x => x.id === conferenceData.sessionId,\n      this._webphone.sessions\n    );\n    const isCurrentConferenceOnhold = currentConferenceSession.isOnHold;\n\n    if (isCurrentConferenceOnhold) {\n      this._webphone.resume(conferenceData.sessionId);\n    }\n\n    return conferenceData;\n  }\n\n  /*\n  * User action track dispatchs\n  * */\n\n  participantListClickHangupTrack() {\n    this.store.dispatch({\n      type: this.actionTypes.participantListClickHangupTrack\n    });\n  }\n\n  removeParticipantClickCancelTrack() {\n    this.store.dispatch({\n      type: this.actionTypes.removeParticipantClickCancelTrack\n    });\n  }\n\n  removeParticipantClickRemoveTrack() {\n    this.store.dispatch({\n      type: this.actionTypes.removeParticipantClickRemoveTrack\n    });\n  }\n\n  get status() {\n    return this.state.status;\n  }\n\n  get conferences() {\n    return this.state.conferences;\n  }\n\n  get conferenceCallStatus() {\n    return this.state.conferenceCallStatus;\n  }\n\n  get isMerging() {\n    return this.state.isMerging;\n  }\n\n  get mergingPair() {\n    return this.state.mergingPair;\n  }\n\n  get currentConferenceId() {\n    return this.state.currentConferenceId;\n  }\n\n  @getter\n  lastCallInfo = createSelector(\n    () => this._webphone.sessions,\n    () => this.mergingPair.fromSessionId,\n    () => this.partyProfiles,\n    (sessions, fromSessionId, partyProfiles) => {\n      if (!fromSessionId) {\n        _lastCallInfo = null;\n        return _lastCallInfo;\n      }\n\n      const lastCall = sessions.find(\n        session => session.id === fromSessionId\n      );\n\n      const toMatches = (lastCall && (\n        this._contactMatcher.dataMapping &&\n        this._contactMatcher.dataMapping[lastCall.to]\n      )) || [];\n\n      let lastCalleeType;\n      if (lastCall) {\n        if (toMatches.length) {\n          lastCalleeType = calleeTypes.contacts;\n        } else if (this.isConferenceSession(lastCall.id)) {\n          lastCalleeType = calleeTypes.conference;\n        } else {\n          lastCalleeType = calleeTypes.unknow;\n        }\n      } else if (\n        _fromSessionId === fromSessionId\n        && _lastCallInfo && _lastCallInfo.calleeType\n      ) {\n        _lastCallInfo = {\n          ..._lastCallInfo,\n          status: sessionStatus.finished,\n        };\n        return _lastCallInfo;\n      } else {\n        return {\n          calleeType: calleeTypes.unknow,\n        };\n      }\n\n      let partiesAvatarUrls = null;\n      if (lastCalleeType === calleeTypes.conference) {\n        partiesAvatarUrls = (partyProfiles || []).map(profile => profile.avatarUrl);\n      }\n      switch (lastCalleeType) {\n        case calleeTypes.conference:\n          _lastCallInfo = {\n            calleeType: calleeTypes.conference,\n            avatarUrl: partiesAvatarUrls[0],\n            extraNum: partiesAvatarUrls.length - 1,\n            name: null,\n            phoneNumber: null,\n            status: lastCall.callStatus,\n            lastCallContact: null,\n          };\n          break;\n        case calleeTypes.contacts:\n          _lastCallInfo = {\n            calleeType: calleeTypes.contacts,\n            avatarUrl: toMatches[0].profileImageUrl,\n            name: toMatches[0].name,\n            status: lastCall.callStatus,\n            phoneNumber: lastCall.to,\n            extraNum: 0,\n            lastCallContact: toMatches[0],\n          };\n          break;\n        default:\n          _lastCallInfo = {\n            calleeType: calleeTypes.unknow,\n            avatarUrl: null,\n            name: null,\n            status: lastCall ? lastCall.callStatus : null,\n            phoneNumber: lastCall.to,\n            extraNum: 0,\n            lastCallContact: null,\n          };\n      }\n\n      _fromSessionId = fromSessionId;\n      return _lastCallInfo;\n    },\n  );\n\n  @getter\n  partyProfiles = createSelector(\n    () => this.currentConferenceId,\n    () => this.conferences,\n    (currentConferenceId, conferences) => {\n      const conferenceData = conferences && conferences[currentConferenceId];\n      if (!conferenceData) {\n        return [];\n      }\n      return this.getOnlinePartyProfiles(currentConferenceId);\n    },\n  )\n}\n\nEventEmitter(ConferenceCall.prototype);\n"]}