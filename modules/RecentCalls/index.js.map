{"version":3,"sources":["modules/RecentCalls/index.js"],"names":["RecentCalls","deps","client","callHistory","options","actionTypes","_client","ensureExist","_callHistory","_reducer","store","subscribe","_onStateChange","pending","ready","dispatch","type","initSuccess","resetSuccess","currentContact","sessionId","contactId","String","id","calls","initLoad","_getRecentCalls","loadSuccess","contact","loadReset","daySpan","length","dateFrom","recentCalls","_getLocalRecentCalls","_fetchRemoteRecentCalls","toISOString","sort","_sortByTime","_dedup","slice","phoneNumbers","reduce","acc","call","to","from","matches","find","_filterPhoneNumber","Date","startTime","concat","phoneNumber","extensionNumber","params","perPage","recentCallsPromises","phoneType","replace","promise","_fetchCallLogList","then","_flattenToRecords","account","extension","callLog","list","items","records","a","b","hash","cur","state","callStatus","loaded","status","RcModule","background"],"mappings":"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","file":"index.js","sourcesContent":["import background from '../../lib/background';\nimport RcModule from '../../lib/RcModule';\nimport { Module } from '../../lib/di';\nimport actionTypes from './actionTypes';\nimport callStatus from './callStatus';\nimport getRecentCallsReducer from './getRecentCallsReducer';\nimport getDateFrom from '../../lib/getDateFrom';\nimport ensureExist from '../../lib/ensureExist';\nimport concurrentExecute from '../../lib/concurrentExecute';\n\n/**\n * @class\n * @description Retrieve all recent calls related to a specified contact.\n */\n@Module({\n  deps: ['Client', 'CallHistory']\n})\nexport default class RecentCalls extends RcModule {\n  /**\n   * @constructor\n   * @param {Object} params - params object\n   * @param {CallHistory} params.callHistory - callHistory module instance\n   * @param {Client} params.client - client module instance\n   */\n  constructor({\n    client,\n    callHistory,\n    ...options\n  }) {\n    super({\n      actionTypes,\n      ...options\n    });\n    this._client = this::ensureExist(client, 'client');\n    this._callHistory = this::ensureExist(callHistory, 'callHistory');\n    this._reducer = getRecentCallsReducer(this.actionTypes);\n  }\n\n  initialize() {\n    this.store.subscribe(() => this._onStateChange());\n  }\n\n  _onStateChange() {\n    if (\n      this.pending &&\n      this._callHistory.ready\n    ) {\n      this.store.dispatch({\n        type: this.actionTypes.initSuccess,\n      });\n    } else if (\n      this.ready &&\n      !this._callHistory.ready\n    ) {\n      this.store.dispatch({\n        type: this.actionTypes.resetSuccess\n      });\n    }\n  }\n\n  get calls() {\n    return this.state.calls;\n  }\n\n  get isCallsLoaded() {\n    return this.state.callStatus === callStatus.loaded;\n  }\n\n  @background\n  async getCalls({ currentContact, sessionId = null }) {\n    // No need to calculate recent calls of the same contact repeatly\n    if (!currentContact) {\n      return;\n    }\n    const contactId = String(currentContact && currentContact.id);\n    // if (this.calls[currentContact.id]) {\n    if (this.calls[sessionId ? `${contactId}-${sessionId}` : contactId]) {\n      return;\n    }\n    this.store.dispatch({\n      type: this.actionTypes.initLoad\n    });\n    const calls = await this._getRecentCalls(\n      currentContact,\n      this._callHistory.calls\n    );\n    this.store.dispatch({\n      type: this.actionTypes.loadSuccess,\n      calls,\n      contact: currentContact,\n      sessionId\n    });\n  }\n\n  cleanUpCalls({ contact, sessionId = null }) {\n    this.store.dispatch({\n      type: this.actionTypes.loadReset,\n      contact,\n      sessionId,\n    });\n  }\n\n  get status() {\n    return this.state.status;\n  }\n\n  /**\n   * Searching for recent calls of specific contact.\n   * @param {Object} currentContact Current contact\n   * @param {Array} calls Calls in callHistory\n   * @param {Number} daySpan Find calls within certain days\n   * @param {Number} length Maximum length of recent calls\n   * @return {Array}\n   * @private\n   */\n  async _getRecentCalls(currentContact, calls = [], daySpan = 60, length = 5) {\n    const dateFrom = getDateFrom(daySpan);\n    let recentCalls = this._getLocalRecentCalls(\n      currentContact,\n      calls,\n      dateFrom\n    );\n\n    // If we could not find enough recent calls,\n    // we need to search for calls on server.\n    if (recentCalls.length < length) {\n      recentCalls = await this._fetchRemoteRecentCalls(\n        currentContact,\n        dateFrom.toISOString(),\n        length\n      );\n    }\n\n    recentCalls.sort(this._sortByTime);\n    recentCalls = this._dedup(recentCalls);\n    return recentCalls.length > length\n      ? recentCalls.slice(0, length)\n      : recentCalls;\n  }\n\n  /**\n   * Get recent calls from callHistory.\n   * @param {Object} currentContact\n   * @param {Array} calls\n   * @param {Date} dateFrom\n   */\n  _getLocalRecentCalls({ phoneNumbers }, calls, dateFrom) {\n    // Get all calls related to this contact\n    return calls.reduce((acc, call) => {\n      if (call && call.to && call.from) {\n        const matches = phoneNumbers.find(this._filterPhoneNumber(call));\n\n        // Check if calls is within certain days\n        if (!!matches && new Date(call.startTime) > dateFrom) {\n          return acc.concat(call);\n        }\n      }\n      return acc;\n    }, []);\n  }\n\n  _filterPhoneNumber(call) {\n    return ({ phoneNumber }) => (\n      phoneNumber === call.from.phoneNumber ||\n      phoneNumber === call.to.phoneNumber ||\n      phoneNumber === call.from.extensionNumber ||\n      phoneNumber === call.to.extensionNumber\n    );\n  }\n\n  /**\n   * Fetch recent calls from server by given current contact.\n   * @param {Object} currentContact\n   * @param {String} dateFrom\n   * @param {String} dateTo\n   * @param {Number} length The number of calls\n   * @return {Array}\n   */\n  _fetchRemoteRecentCalls(\n    { phoneNumbers },\n    dateFrom,\n    length\n  ) {\n    const params = {\n      dateFrom,\n      perPage: length,\n      type: 'Voice'\n    };\n\n    // CallLog API doesn't support plus sign in phoneNumber\n    const recentCallsPromises = phoneNumbers.reduce((acc, { phoneType, phoneNumber }) => {\n      phoneNumber = phoneNumber.replace('+', '');\n      if (phoneType === 'extension') {\n        const promise = this._fetchCallLogList(\n          Object.assign({}, params, {\n            extensionNumber: phoneNumber\n          })\n        );\n        return acc.concat(promise);\n      }\n      const promise = this._fetchCallLogList(\n        Object.assign({}, params, {\n          phoneNumber\n        })\n      );\n      return acc.concat(promise);\n    }, []);\n\n    return concurrentExecute(recentCallsPromises, 5, 500)\n      .then(this._flattenToRecords);\n  }\n\n  _fetchCallLogList(params) {\n    return () => this._client.account().extension().callLog().list(params);\n  }\n\n  _flattenToRecords(items) {\n    return items.reduce((acc, { records }) => acc.concat(records), []);\n  }\n\n  // Sort by time in descending order\n  _sortByTime(a, b) {\n    return new Date(b.startTime) - new Date(a.startTime);\n  }\n\n  _dedup(calls) {\n    const hash = {};\n    return calls.reduce((acc, cur) => {\n      if (hash[cur.id]) return acc;\n      hash[cur.id] = true;\n      return acc.concat(cur);\n    }, []);\n  }\n}\n"]}