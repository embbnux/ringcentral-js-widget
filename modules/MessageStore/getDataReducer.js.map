{"version":3,"sources":["modules/MessageStore/getDataReducer.js"],"names":["getConversationListReducer","getConversationStoreReducer","getTimestampReducer","getSyncInfoReducer","getDataReducer","messageHelper","types","state","type","records","conversationId","conversationStore","newState","stateMap","conversationsISyncSuccess","conversationsFSyncSuccess","updateMessages","length","forEach","oldConversation","push","id","index","record","message","normalizeRecord","newCreationTime","creationTime","isDeleted","messageIsDeleted","messageId","oldMessageList","exsitedMessageList","filter","m","messageIsAcceptable","c","sort","sortByCreationTime","deleteConversation","resetSuccess","updatedConversations","newMessages","concat","oldMessageIndex","findIndex","r","lastModifiedTime","noSorted","timestamp","syncInfo","conversationList"],"mappings":";;;;;;;;;;;;;;QAGgBA,0B,GAAAA,0B;QAgFAC,2B,GAAAA,2B;QA0DAC,mB,GAAAA,mB;QAcAC,kB,GAAAA,kB;kBAcQC,c;;AAzKxB;;AACA;;IAAYC,a;;;;;;AAEL,SAASL,0BAAT,CAAoCM,KAApC,EAA2C;AAChD,SAAO,YAED;AAAA,QAFEC,KAEF,uEAFU,EAEV;AAAA;AAAA,QADJC,IACI,QADJA,IACI;AAAA,QADEC,OACF,QADEA,OACF;AAAA,QADWC,cACX,QADWA,cACX;AAAA,QAD2BC,iBAC3B,QAD2BA,iBAC3B;;AACJ,QAAMC,WAAW,EAAjB;AACA,QAAMC,WAAW,EAAjB;AACA,YAAQL,IAAR;AACE,WAAKF,MAAMQ,yBAAX;AACA,WAAKR,MAAMS,yBAAX;AACA,WAAKT,MAAMU,cAAX;AACE,YAAIR,SAASF,MAAMS,yBAAnB,EAA8C;AAC5C,cAAI,CAACN,OAAD,IAAYA,QAAQQ,MAAR,KAAmB,CAAnC,EAAsC;AACpC,mBAAOV,KAAP;AACD;AACDA,gBAAMW,OAAN,CAAc,UAACC,eAAD,EAAqB;AACjCP,qBAASQ,IAAT,CAAcD,eAAd;AACAN,qBAASM,gBAAgBE,EAAzB,IAA+B;AAC7BC,qBAAOV,SAASK,MAAT,GAAkB;AADI,aAA/B;AAGD,WALD;AAMD;AACDR,gBAAQS,OAAR,CAAgB,UAACK,MAAD,EAAY;AAC1B,cAAMC,UAAUnB,cAAcoB,eAAd,CAA8BF,MAA9B,CAAhB;AACA,cAAMF,KAAKG,QAAQd,cAAnB;AACA,cAAMgB,kBAAkBF,QAAQG,YAAhC;AACA,cAAMC,YAAYvB,cAAcwB,gBAAd,CAA+BL,OAA/B,CAAlB;AACA,cAAIX,SAASQ,EAAT,CAAJ,EAAkB;AAChB,gBAAMF,kBAAkBP,SAASC,SAASQ,EAAT,EAAaC,KAAtB,CAAxB;AACA,gBAAMK,eAAeR,gBAAgBQ,YAArC;AACA,gBAAIA,eAAeD,eAAf,IAAkC,CAACE,SAAvC,EAAkD;AAChDhB,uBAASC,SAASQ,EAAT,EAAaC,KAAtB,IAA+B;AAC7BD,sBAD6B;AAE7BM,8BAAcD,eAFe;AAG7BlB,sBAAMgB,QAAQhB,IAHe;AAI7BsB,2BAAWN,QAAQH;AAJU,eAA/B;AAMD;AACD;AACA,gBAAIO,aAAaJ,QAAQH,EAAR,KAAeF,gBAAgBW,SAAhD,EAA2D;AACzD,kBAAMC,iBAAiBpB,kBAAkBU,EAAlB,KAAyB,EAAhD;AACA,kBAAMW,qBAAqBD,eAAeE,MAAf,CAAsB;AAAA,uBAAKC,EAAEb,EAAF,KAASG,QAAQH,EAAtB;AAAA,eAAtB,CAA3B;AACA,kBAAIW,mBAAmBf,MAAnB,GAA4B,CAAhC,EAAmC;AACjCL,yBAASC,SAASQ,EAAT,EAAaC,KAAtB,IAA+B;AAC7BD,wBAD6B;AAE7BM,gCAAcK,mBAAmB,CAAnB,EAAsBL,YAFP;AAG7BnB,wBAAMwB,mBAAmB,CAAnB,EAAsBxB,IAHC;AAI7BsB,6BAAWE,mBAAmB,CAAnB,EAAsBX;AAJJ,iBAA/B;AAMA;AACD;AACD;AACAT,uBAASC,SAASQ,EAAT,EAAaC,KAAtB,IAA+B,IAA/B;AACA,qBAAOT,SAASQ,EAAT,CAAP;AACD;AACD;AACD;AACD,cAAIO,aAAa,CAACvB,cAAc8B,mBAAd,CAAkCX,OAAlC,CAAlB,EAA8D;AAC5D;AACD;AACDZ,mBAASQ,IAAT,CAAc;AACZC,kBADY;AAEZM,0BAAcD,eAFF;AAGZlB,kBAAMgB,QAAQhB,IAHF;AAIZsB,uBAAWN,QAAQH;AAJP,WAAd;AAMAR,mBAASQ,EAAT,IAAe;AACbC,mBAAOV,SAASK,MAAT,GAAkB;AADZ,WAAf;AAGD,SA/CD;AAgDA,eAAOL,SAASqB,MAAT,CAAgB;AAAA,iBAAK,CAAC,CAACG,CAAP;AAAA,SAAhB,EAA0BC,IAA1B,CAA+BhC,cAAciC,kBAA7C,CAAP;AACF,WAAKhC,MAAMiC,kBAAX;AACE,eAAOhC,MAAM0B,MAAN,CAAa;AAAA,iBAAKG,EAAEf,EAAF,KAASX,cAAd;AAAA,SAAb,CAAP;AACF,WAAKJ,MAAMkC,YAAX;AACE,eAAO,EAAP;AACF;AACE,eAAOjC,KAAP;AArEJ;AAuED,GA5ED;AA6ED;;AAEM,SAASN,2BAAT,CAAqCK,KAArC,EAA4C;AACjD,SAAO,YAAmD;AAAA,QAAlDC,KAAkD,uEAA1C,EAA0C;AAAA;AAAA,QAApCC,IAAoC,SAApCA,IAAoC;AAAA,QAA9BC,OAA8B,SAA9BA,OAA8B;AAAA,QAArBC,cAAqB,SAArBA,cAAqB;;AACxD,QAAIE,WAAW,EAAf;AACA,QAAM6B,uBAAuB,EAA7B;AACA,YAAQjC,IAAR;AACE,WAAKF,MAAMQ,yBAAX;AACA,WAAKR,MAAMS,yBAAX;AACA,WAAKT,MAAMU,cAAX;AACE,YAAIR,SAASF,MAAMS,yBAAnB,EAA8C;AAC5C,cAAI,CAACN,OAAD,IAAYA,QAAQQ,MAAR,KAAmB,CAAnC,EAAsC;AACpC,mBAAOV,KAAP;AACD;AACDK,gDACKL,KADL;AAGD;AACDE,gBAAQS,OAAR,CAAgB,UAACK,MAAD,EAAY;AAC1B,cAAMC,UAAUnB,cAAcoB,eAAd,CAA8BF,MAA9B,CAAhB;AACA,cAAMF,KAAKG,QAAQd,cAAnB;AACA,cAAMgC,cAAc9B,SAASS,EAAT,IAAe,GAAGsB,MAAH,CAAU/B,SAASS,EAAT,CAAV,CAAf,GAAyC,EAA7D;AACA,cAAMuB,kBAAkBF,YAAYG,SAAZ,CAAsB;AAAA,mBAAKC,EAAEzB,EAAF,KAASE,OAAOF,EAArB;AAAA,WAAtB,CAAxB;AACA,cAAIhB,cAAcwB,gBAAd,CAA+BL,OAA/B,CAAJ,EAA6C;AAC3CZ,qBAASS,EAAT,IAAeqB,YAAYT,MAAZ,CAAmB;AAAA,qBAAKC,EAAEb,EAAF,KAASG,QAAQH,EAAtB;AAAA,aAAnB,CAAf;AACA,gBAAIT,SAASS,EAAT,EAAaJ,MAAb,KAAwB,CAA5B,EAA+B;AAC7B,qBAAOL,SAASS,EAAT,CAAP;AACD;AACD;AACD;AACD,cAAIuB,kBAAkB,CAAC,CAAvB,EAA0B;AACxB,gBAAIF,YAAYE,eAAZ,EAA6BG,gBAA7B,GAAgDvB,QAAQuB,gBAA5D,EAA8E;AAC5EL,0BAAYE,eAAZ,IAA+BpB,OAA/B;AACD;AACF,WAJD,MAIO,IAAInB,cAAc8B,mBAAd,CAAkCX,OAAlC,CAAJ,EAAgD;AACrDkB,wBAAYtB,IAAZ,CAAiBI,OAAjB;AACD;AACDiB,+BAAqBpB,EAArB,IAA2B,CAA3B;AACAT,mBAASS,EAAT,IAAeqB,WAAf;AACD,SArBD;AAsBA,4BAAYD,oBAAZ,EAAkCvB,OAAlC,CAA0C,UAACG,EAAD,EAAQ;AAChD,cAAM2B,WAAWpC,SAASS,EAAT,CAAjB;AACAT,mBAASS,EAAT,IAAe2B,SAASX,IAAT,CAAchC,cAAciC,kBAA5B,CAAf;AACD,SAHD;AAIA,eAAO1B,QAAP;AACF,WAAKN,MAAMiC,kBAAX;AACE,YAAI,CAAChC,MAAMG,cAAN,CAAL,EAA4B;AAC1B,iBAAOH,KAAP;AACD;AACDK,8CAAgBL,KAAhB;AACA,eAAOK,SAASF,cAAT,CAAP;AACA,eAAOE,QAAP;AACF,WAAKN,MAAMkC,YAAX;AACE,eAAO,EAAP;AACF;AACE,eAAOjC,KAAP;AAjDJ;AAmDD,GAtDD;AAuDD;;AAEM,SAASL,mBAAT,CAA6BI,KAA7B,EAAoC;AACzC,SAAO,YAAuC;AAAA,QAAtCC,KAAsC,uEAA9B,IAA8B;AAAA;AAAA,QAAtBC,IAAsB,SAAtBA,IAAsB;AAAA,QAAhByC,SAAgB,SAAhBA,SAAgB;;AAC5C,YAAQzC,IAAR;AACE,WAAKF,MAAMS,yBAAX;AACA,WAAKT,MAAMQ,yBAAX;AACE,eAAOmC,SAAP;AACF,WAAK3C,MAAMkC,YAAX;AACE,eAAO,IAAP;AACF;AACE,eAAOjC,KAAP;AAPJ;AASD,GAVD;AAWD;;AAEM,SAASJ,kBAAT,CAA4BG,KAA5B,EAAmC;AACxC,SAAO,YAAsC;AAAA,QAArCC,KAAqC,uEAA7B,IAA6B;AAAA;AAAA,QAArBC,IAAqB,SAArBA,IAAqB;AAAA,QAAf0C,QAAe,SAAfA,QAAe;;AAC3C,YAAQ1C,IAAR;AACE,WAAKF,MAAMS,yBAAX;AACA,WAAKT,MAAMQ,yBAAX;AACE,eAAOoC,QAAP;AACF,WAAK5C,MAAMkC,YAAX;AACE,eAAO,IAAP;AACF;AACE,eAAOjC,KAAP;AAPJ;AASD,GAVD;AAWD;;AAEc,SAASH,cAAT,CAAwBE,KAAxB,EAA+B;AAC5C,SAAO,4BAAgB;AACrB6C,sBAAkBnD,2BAA2BM,KAA3B,CADG;AAErBK,uBAAmBV,4BAA4BK,KAA5B,CAFE;AAGrB4C,cAAU/C,mBAAmBG,KAAnB,CAHW;AAIrB2C,eAAW/C,oBAAoBI,KAApB;AAJU,GAAhB,CAAP;AAMD","file":"getDataReducer.js","sourcesContent":["import { combineReducers } from 'redux';\nimport * as messageHelper from '../../lib/messageHelper';\n\nexport function getConversationListReducer(types) {\n  return (state = [], {\n    type, records, conversationId, conversationStore\n  }) => {\n    const newState = [];\n    const stateMap = {};\n    switch (type) {\n      case types.conversationsISyncSuccess:\n      case types.conversationsFSyncSuccess:\n      case types.updateMessages:\n        if (type !== types.conversationsFSyncSuccess) {\n          if (!records || records.length === 0) {\n            return state;\n          }\n          state.forEach((oldConversation) => {\n            newState.push(oldConversation);\n            stateMap[oldConversation.id] = {\n              index: newState.length - 1\n            };\n          });\n        }\n        records.forEach((record) => {\n          const message = messageHelper.normalizeRecord(record);\n          const id = message.conversationId;\n          const newCreationTime = message.creationTime;\n          const isDeleted = messageHelper.messageIsDeleted(message);\n          if (stateMap[id]) {\n            const oldConversation = newState[stateMap[id].index];\n            const creationTime = oldConversation.creationTime;\n            if (creationTime < newCreationTime && !isDeleted) {\n              newState[stateMap[id].index] = {\n                id,\n                creationTime: newCreationTime,\n                type: message.type,\n                messageId: message.id,\n              };\n            }\n            // when user deleted a coversation message\n            if (isDeleted && message.id === oldConversation.messageId) {\n              const oldMessageList = conversationStore[id] || [];\n              const exsitedMessageList = oldMessageList.filter(m => m.id !== message.id);\n              if (exsitedMessageList.length > 0) {\n                newState[stateMap[id].index] = {\n                  id,\n                  creationTime: exsitedMessageList[0].creationTime,\n                  type: exsitedMessageList[0].type,\n                  messageId: exsitedMessageList[0].id,\n                };\n                return;\n              }\n              // when user delete conversation\n              newState[stateMap[id].index] = null;\n              delete stateMap[id];\n            }\n            return;\n          }\n          if (isDeleted || !messageHelper.messageIsAcceptable(message)) {\n            return;\n          }\n          newState.push({\n            id,\n            creationTime: newCreationTime,\n            type: message.type,\n            messageId: message.id,\n          });\n          stateMap[id] = {\n            index: newState.length - 1\n          };\n        });\n        return newState.filter(c => !!c).sort(messageHelper.sortByCreationTime);\n      case types.deleteConversation:\n        return state.filter(c => c.id !== conversationId);\n      case types.resetSuccess:\n        return [];\n      default:\n        return state;\n    }\n  };\n}\n\nexport function getConversationStoreReducer(types) {\n  return (state = {}, { type, records, conversationId }) => {\n    let newState = {};\n    const updatedConversations = {};\n    switch (type) {\n      case types.conversationsISyncSuccess:\n      case types.conversationsFSyncSuccess:\n      case types.updateMessages:\n        if (type !== types.conversationsFSyncSuccess) {\n          if (!records || records.length === 0) {\n            return state;\n          }\n          newState = {\n            ...state,\n          };\n        }\n        records.forEach((record) => {\n          const message = messageHelper.normalizeRecord(record);\n          const id = message.conversationId;\n          const newMessages = newState[id] ? [].concat(newState[id]) : [];\n          const oldMessageIndex = newMessages.findIndex(r => r.id === record.id);\n          if (messageHelper.messageIsDeleted(message)) {\n            newState[id] = newMessages.filter(m => m.id !== message.id);\n            if (newState[id].length === 0) {\n              delete newState[id];\n            }\n            return;\n          }\n          if (oldMessageIndex > -1) {\n            if (newMessages[oldMessageIndex].lastModifiedTime < message.lastModifiedTime) {\n              newMessages[oldMessageIndex] = message;\n            }\n          } else if (messageHelper.messageIsAcceptable(message)) {\n            newMessages.push(message);\n          }\n          updatedConversations[id] = 1;\n          newState[id] = newMessages;\n        });\n        Object.keys(updatedConversations).forEach((id) => {\n          const noSorted = newState[id];\n          newState[id] = noSorted.sort(messageHelper.sortByCreationTime);\n        });\n        return newState;\n      case types.deleteConversation:\n        if (!state[conversationId]) {\n          return state;\n        }\n        newState = { ...state };\n        delete newState[conversationId];\n        return newState;\n      case types.resetSuccess:\n        return {};\n      default:\n        return state;\n    }\n  };\n}\n\nexport function getTimestampReducer(types) {\n  return (state = null, { type, timestamp }) => {\n    switch (type) {\n      case types.conversationsFSyncSuccess:\n      case types.conversationsISyncSuccess:\n        return timestamp;\n      case types.resetSuccess:\n        return null;\n      default:\n        return state;\n    }\n  };\n}\n\nexport function getSyncInfoReducer(types) {\n  return (state = null, { type, syncInfo }) => {\n    switch (type) {\n      case types.conversationsFSyncSuccess:\n      case types.conversationsISyncSuccess:\n        return syncInfo;\n      case types.resetSuccess:\n        return null;\n      default:\n        return state;\n    }\n  };\n}\n\nexport default function getDataReducer(types) {\n  return combineReducers({\n    conversationList: getConversationListReducer(types),\n    conversationStore: getConversationStoreReducer(types),\n    syncInfo: getSyncInfoReducer(types),\n    timestamp: getTimestampReducer(types),\n  });\n}\n"]}