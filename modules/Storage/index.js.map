{"version":3,"sources":["modules/Storage/index.js"],"names":["DEFAULT_DISABLE_ALLOW_INACTIVE_TABS_WRITE","Storage","deps","dep","optional","disableAllowInactiveTabsWrite","auth","tabManager","options","name","_disableAllowInactiveTabsWrite","_auth","_tabManager","storedData","store","subscribe","loginStatus","loggedIn","ready","pending","dispatch","type","actionTypes","init","storageKey","prefix","ownerId","_storage","_StorageProvider","getData","key","_reducers","removeItem","initSuccess","data","_storageHandler","value","sync","on","notLoggedIn","reset","off","destroy","resetSuccess","status","moduleStatuses","active","currentData","setItem","StorageBase"],"mappings":"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","file":"index.js","sourcesContent":["import { Module } from '../../lib/di';\nimport StorageBase from '../../lib/StorageBase';\nimport loginStatus from '../Auth/loginStatus';\nimport moduleStatuses from '../../enums/moduleStatuses';\n\nconst DEFAULT_DISABLE_ALLOW_INACTIVE_TABS_WRITE = false;\n\n/**\n * @class\n * @description Alternative implementation of the Storage class.\n *  Allows registeration of reducers so that persisted states can be computed with reducers.\n */\n@Module({\n  deps: [\n    'Auth',\n    { dep: 'TabManager', optional: true },\n    { dep: 'StorageOptions', optional: true },\n  ]\n})\nexport default class Storage extends StorageBase {\n  /**\n   * @constructor\n   * @param {Object} params - params object\n   * @param {disableAllowInactiveTabsWrite} params.disableAllowInactiveTabsWrite - disable Allow Inactive Tabs Write\n   * @param {Auth} params.auth - auth module instance\n   * @param {TabManager} params.tabManager - tabManager module instance\n   */\n  constructor({\n    disableAllowInactiveTabsWrite = DEFAULT_DISABLE_ALLOW_INACTIVE_TABS_WRITE,\n    auth,\n    tabManager,\n    ...options\n  }) {\n    super({\n      name: 'storage',\n      ...options,\n    });\n    this._disableAllowInactiveTabsWrite = disableAllowInactiveTabsWrite;\n    this._auth = auth;\n    this._tabManager = tabManager;\n  }\n  initialize() {\n    let storedData = null;\n    this.store.subscribe(async () => {\n      if (\n        this._auth.loginStatus === loginStatus.loggedIn &&\n        (!this._tabManager || this._tabManager.ready) &&\n        this.pending\n      ) {\n        this.store.dispatch({\n          type: this.actionTypes.init,\n        });\n        const storageKey =\n          `${this.prefix ? `${this.prefix}-` : ''}storage-${this._auth.ownerId}`;\n        this._storage = new this._StorageProvider({\n          storageKey,\n        });\n        storedData = await this._storage.getData();\n        for (const key in storedData) {\n          if (!this._reducers[key]) {\n            delete storedData[key];\n            await this._storage.removeItem(key);\n          }\n        }\n        this.store.dispatch({\n          type: this.actionTypes.initSuccess,\n          storageKey,\n          // To fix same reference in redux store with storedData\n          data: {\n            ...storedData,\n          },\n        });\n        this._storageHandler = ({ key, value }) => {\n          if (this.ready) {\n            storedData[key] = value;\n            this.store.dispatch({\n              type: this.actionTypes.sync,\n              key,\n              value,\n            });\n          }\n        };\n        this._storage.on('storage', this._storageHandler);\n      } else if (\n        (\n          (!!this._tabManager && !this._tabManager.ready) ||\n          this._auth.notLoggedIn\n        ) && this.ready\n      ) {\n        this.store.dispatch({\n          type: this.actionTypes.reset,\n        });\n        if (this._storageHandler) {\n          this._storage.off('storage', this._storageHandler);\n          this._storageHandler = null;\n        }\n        if (this._storage) {\n          this._storage.destroy();\n          this._storage = null;\n        }\n        this.store.dispatch({\n          type: this.actionTypes.resetSuccess,\n        });\n      }\n      if (\n        this.status === moduleStatuses.ready && (\n          !this._disableAllowInactiveTabsWrite ||\n          !this._tabManager ||\n          this._tabManager.active\n        )\n      ) {\n        // save new data to storage when changed\n        const currentData = this.data;\n        for (const key in currentData) {\n          if (storedData[key] !== currentData[key]) {\n            this._storage.setItem(key, currentData[key]);\n            storedData[key] = currentData[key];\n          }\n        }\n      }\n    });\n  }\n}\n"]}