{"version":3,"sources":["modules/CallingSettings/index.js"],"names":["CallingSettings","deps","dep","optional","alert","brand","extensionInfo","extensionPhoneNumber","forwardingNumber","storage","rolesAndPermissions","tabManager","onFirstLogin","webphone","options","actionTypes","_alert","_brand","_extensionInfo","_extensionPhoneNumber","_forwardingNumber","_storage","_rolesAndPermissions","_tabManager","_webphone","_callWithStorageKey","_ringoutPromptStorageKey","_myLocationStorageKey","_timestampStorageKey","_fromNumberStorageKey","_onFirstLogin","registerReducer","key","reducer","_reducer","addSelector","directNumbers","mainCompanyNumber","extensionNumber","myPhoneNumbers","map","item","phoneNumber","push","flipNumbers","callerIdNumbers","filterMapping","forEach","filter","sort","a","b","label","phoneNumbers","firstItem","lastItem","usageType","ringoutEnabled","webphoneEnabled","otherPhoneNumbers","length","numbers","hasOtherPhone","hasExtensionPhoneNumber","callingOptions","softphone","callWithOptions","browser","myphone","otherphone","customphone","store","subscribe","_onStateChange","_shouldInit","dispatch","type","init","_init","initSuccess","_shouldReset","_reset","_shouldValidate","_ringoutEnabled","_webphoneEnabled","_myPhoneNumbers","_otherPhoneNumbers","_validateSettings","ready","pending","callingEnabled","timestamp","defaultCallWith","setData","callWith","Date","now","_warningEmergencyCallingNotAvailable","_initFromNumber","resetSuccess","fromNumber","fromNumberList","fromNumbers","updateFromNumber","number","_hasWebphonePermissionRemoved","_setSoftPhoneToCallWith","danger","message","callingSettingsMessages","webphonePermissionRemoved","ttl","_hasPermissionChanged","permissionChanged","_hasPhoneNumberChanged","myLocation","phoneNumberChanged","indexOf","info","emergencyCallingNotAvailable","withPrompt","ringoutPrompt","saveSuccessWithSoftphone","saveSuccess","state","status","moduleStatuses","getItem","_selectors","availableNumbers","RcModule","proxify"],"mappings":"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","file":"index.js","sourcesContent":["import RcModule from '../../lib/RcModule';\nimport { Module } from '../../lib/di';\nimport getCallingSettingsReducer, {\n  getCallWithReducer,\n  getRingoutPromptReducer,\n  getMyLocationReducer,\n  getTimestampReducer,\n  getFromNumberReducer,\n} from './getCallingSettingsReducer';\nimport moduleStatuses from '../../enums/moduleStatuses';\nimport mapOptionToMode from './mapOptionToMode';\nimport callingOptions from './callingOptions';\nimport callingSettingsMessages from './callingSettingsMessages';\nimport actionTypes from './actionTypes';\nimport proxify from '../../lib/proxy/proxify';\n\n/**\n * @class\n * @description Call setting managing module\n */\n@Module({\n  deps: [\n    'Alert',\n    'Brand',\n    'ExtensionInfo',\n    'ExtensionPhoneNumber',\n    'ForwardingNumber',\n    'Storage',\n    'RolesAndPermissions',\n    { dep: 'TabManager', optional: true },\n    { dep: 'Webphone', optional: true },\n    { dep: 'CallingSettingsOptions', optional: true }\n  ]\n})\nexport default class CallingSettings extends RcModule {\n  /**\n   * @constructor\n   * @param {Object} params - params object\n   * @param {Alert} params.alert - alert module instance\n   * @param {Brand} params.brand - brand module instance\n   * @param {ExtensionInfo} params.extensionInfo - extensionInfo module instance\n   * @param {ExtensionPhoneNumber} params.extensionPhoneNumber - extensionPhoneNumber module instance\n   * @param {ForwardingNumber} params.forwardingNumber - forwardingNumber module instance\n   * @param {Storage} params.storage - storage module instance\n   * @param {RolesAndPermissions} params.rolesAndPermissions - rolesAndPermissions module instance\n   * @param {TabManager} params.tabManager - tabManager module instance\n   * @param {Webphone} params.webphone - webphone module instance\n   * @param {Function} params.onFirstLogin - func on first login\n   */\n  constructor({\n    alert,\n    brand,\n    extensionInfo,\n    extensionPhoneNumber,\n    forwardingNumber,\n    storage,\n    rolesAndPermissions,\n    tabManager,\n    onFirstLogin,\n    webphone,\n    ...options\n  }) {\n    super({\n      ...options,\n      actionTypes,\n    });\n    this._alert = alert;\n    this._brand = brand;\n    this._extensionInfo = extensionInfo;\n    this._extensionPhoneNumber = extensionPhoneNumber;\n    this._forwardingNumber = forwardingNumber;\n    this._storage = storage;\n    this._rolesAndPermissions = rolesAndPermissions;\n    this._tabManager = tabManager;\n    this._webphone = webphone;\n\n    this._callWithStorageKey = 'callingSettingsCallWith';\n    this._ringoutPromptStorageKey = 'callingSettingsRingoutPrompt';\n    this._myLocationStorageKey = 'callingSettingsMyLocation';\n    this._timestampStorageKey = 'callingSettingsTimestamp';\n    this._fromNumberStorageKey = 'fromCallIdNumber';\n\n    this._onFirstLogin = onFirstLogin;\n\n    this._storage.registerReducer({\n      key: this._callWithStorageKey,\n      reducer: getCallWithReducer(this.actionTypes),\n    });\n    this._storage.registerReducer({\n      key: this._ringoutPromptStorageKey,\n      reducer: getRingoutPromptReducer(this.actionTypes),\n    });\n    this._storage.registerReducer({\n      key: this._myLocationStorageKey,\n      reducer: getMyLocationReducer(this.actionTypes),\n    });\n    this._storage.registerReducer({\n      key: this._timestampStorageKey,\n      reducer: getTimestampReducer(this.actionTypes),\n    });\n    this._storage.registerReducer({\n      key: this._fromNumberStorageKey,\n      reducer: getFromNumberReducer(this.actionTypes),\n    });\n    this._reducer = getCallingSettingsReducer(this.actionTypes);\n\n    this.addSelector('myPhoneNumbers',\n      () => this._extensionPhoneNumber.directNumbers,\n      () => this._extensionPhoneNumber.mainCompanyNumber,\n      () => this._extensionInfo.extensionNumber,\n      (directNumbers, mainCompanyNumber, extensionNumber) => {\n        const myPhoneNumbers = directNumbers.map(item => item.phoneNumber);\n        if (mainCompanyNumber && extensionNumber) {\n          myPhoneNumbers.push(`${mainCompanyNumber.phoneNumber}*${extensionNumber}`);\n        }\n        return myPhoneNumbers;\n      }\n    );\n\n    this.addSelector('otherPhoneNumbers',\n      () => this._forwardingNumber.flipNumbers,\n      () => this._extensionPhoneNumber.callerIdNumbers,\n      () => this._extensionPhoneNumber.directNumbers,\n      (flipNumbers, callerIdNumbers, directNumbers) => {\n        const filterMapping = {};\n        callerIdNumbers.forEach((item) => {\n          filterMapping[item.phoneNumber] = true;\n        });\n        directNumbers.forEach((item) => {\n          filterMapping[item.phoneNumber] = true;\n        });\n        return flipNumbers\n          .filter(item => !filterMapping[item.phoneNumber])\n          .sort((a, b) => (a.label === 'Mobile' && a.label !== b.label ? -1 : 1))\n          .map(item => item.phoneNumber);\n      }\n    );\n\n    this.addSelector(\n      'fromNumbers',\n      () => this._extensionPhoneNumber.callerIdNumbers,\n      phoneNumbers => phoneNumbers.sort((firstItem, lastItem) => {\n        if (firstItem.usageType === 'DirectNumber') return -1;\n        else if (lastItem.usageType === 'DirectNumber') return 1;\n        else if (firstItem.usageType === 'MainCompanyNumber') return -1;\n        else if (lastItem.usageType === 'MainCompanyNumber') return 1;\n        else if (firstItem.usageType < lastItem.usageType) return -1;\n        else if (firstItem.usageType > lastItem.usageType) return 1;\n        return 0;\n      }),\n    );\n\n    this.addSelector('callWithOptions',\n      () => this._rolesAndPermissions.ringoutEnabled,\n      () => this._rolesAndPermissions.webphoneEnabled,\n      () => this.otherPhoneNumbers.length > 0,\n      () => this._extensionPhoneNumber.numbers.length > 0,\n      (ringoutEnabled, webphoneEnabled, hasOtherPhone, hasExtensionPhoneNumber) => {\n        if (!hasExtensionPhoneNumber) {\n          return [callingOptions.softphone];\n        }\n        const callWithOptions = [];\n        if (this._webphone && webphoneEnabled) {\n          callWithOptions.push(callingOptions.browser);\n        }\n        callWithOptions.push(callingOptions.softphone);\n        if (ringoutEnabled) {\n          callWithOptions.push(callingOptions.myphone);\n          if (hasOtherPhone) {\n            callWithOptions.push(callingOptions.otherphone);\n          }\n          callWithOptions.push(callingOptions.customphone);\n        }\n        return callWithOptions;\n      },\n    );\n    this.addSelector('availableNumbers',\n      () => this.myPhoneNumbers,\n      () => this.otherPhoneNumbers,\n      (myPhoneNumbers, otherPhoneNumbers) => ({\n        [callingOptions.myphone]: myPhoneNumbers,\n        [callingOptions.otherphone]: otherPhoneNumbers,\n      }),\n    );\n  }\n\n  initialize() {\n    this.store.subscribe(() => this._onStateChange());\n  }\n  async _onStateChange() {\n    if (this._shouldInit()) {\n      this.store.dispatch({\n        type: this.actionTypes.init,\n      });\n      await this._init();\n      this.store.dispatch({\n        type: this.actionTypes.initSuccess,\n      });\n    } else if (this._shouldReset()) {\n      this._reset();\n    } else if (this._shouldValidate()) {\n      this._ringoutEnabled = this._rolesAndPermissions.ringoutEnabled;\n      this._webphoneEnabled = this._rolesAndPermissions.webphoneEnabled;\n      this._myPhoneNumbers = this.myPhoneNumbers;\n      this._otherPhoneNumbers = this.otherPhoneNumbers;\n      await this._validateSettings();\n    }\n  }\n  _shouldInit() {\n    return (\n      this._storage.ready &&\n      this._extensionInfo.ready &&\n      this._extensionPhoneNumber.ready &&\n      this._forwardingNumber.ready &&\n      this._rolesAndPermissions.ready &&\n      this.pending\n    );\n  }\n  _shouldReset() {\n    return (\n      this.ready &&\n      (\n        !this._storage.ready ||\n        !this._extensionInfo.ready ||\n        !this._extensionPhoneNumber.ready ||\n        !this._forwardingNumber.ready ||\n        !this._rolesAndPermissions.ready\n      )\n    );\n  }\n  _shouldValidate() {\n    return (\n      this.ready &&\n      (\n        this._ringoutEnabled !== this._rolesAndPermissions.ringoutEnabled ||\n        this._webphoneEnabled !== this._rolesAndPermissions.webphoneEnabled ||\n        this._myPhoneNumbers !== this.myPhoneNumbers ||\n        this._otherPhoneNumbers !== this.otherPhoneNumbers\n      )\n    );\n  }\n  async _init() {\n    if (!this._rolesAndPermissions.callingEnabled) return;\n    this._myPhoneNumbers = this.myPhoneNumbers;\n    this._otherPhoneNumbers = this.otherPhoneNumbers;\n    this._ringoutEnabled = this._rolesAndPermissions.ringoutEnabled;\n    this._webphoneEnabled = this._rolesAndPermissions.webphoneEnabled;\n    if (!this.timestamp) {\n      // first time login\n      const defaultCallWith = this.callWithOptions && this.callWithOptions[0];\n      this.store.dispatch({\n        type: this.actionTypes.setData,\n        callWith: defaultCallWith,\n        timestamp: Date.now(),\n      });\n      this._warningEmergencyCallingNotAvailable();\n      if (typeof this._onFirstLogin === 'function') {\n        this._onFirstLogin();\n      }\n    }\n    await this._validateSettings();\n    await this._initFromNumber();\n  }\n\n  _reset() {\n    this.store.dispatch({\n      type: this.actionTypes.resetSuccess,\n    });\n  }\n\n  @proxify\n  async _initFromNumber() {\n    const fromNumber = this.fromNumber;\n    if (!fromNumber) {\n      const fromNumberList = this.fromNumbers;\n      await this.updateFromNumber(fromNumberList[0]);\n    }\n  }\n\n  @proxify\n  async updateFromNumber(number) {\n    this.store.dispatch({\n      type: this.actionTypes.updateFromNumber,\n      number: number && number.phoneNumber,\n    });\n  }\n\n  @proxify\n  async _setSoftPhoneToCallWith() {\n    this.store.dispatch({\n      type: this.actionTypes.setData,\n      callWith: callingOptions.softphone,\n      timestamp: Date.now(),\n    });\n  }\n\n  @proxify\n  async _validateSettings() {\n    if (this._hasWebphonePermissionRemoved()) {\n      await this._setSoftPhoneToCallWith();\n      this._alert.danger({\n        message: callingSettingsMessages.webphonePermissionRemoved,\n        ttl: 0,\n      });\n    } else if (this._hasPermissionChanged()) {\n      await this._setSoftPhoneToCallWith();\n      this._alert.danger({\n        message: callingSettingsMessages.permissionChanged,\n        ttl: 0,\n      });\n    } else if (this._hasPhoneNumberChanged()) {\n      this.store.dispatch({\n        type: this.actionTypes.setData,\n        callWith: callingOptions.myphone,\n        myLocation: this._myPhoneNumbers[0],\n        timestamp: Date.now(),\n      });\n      this._alert.danger({\n        message: callingSettingsMessages.phoneNumberChanged,\n        ttl: 0,\n      });\n    }\n  }\n  _hasWebphonePermissionRemoved() {\n    return (!(\n      this._webphoneEnabled &&\n        this._webphone\n    ) &&\n      this.callWith === callingOptions.browser);\n  }\n  _hasPermissionChanged() {\n    return (\n      !this._ringoutEnabled &&\n      (\n        this.callWith === callingOptions.myphone ||\n        this.callWith === callingOptions.otherphone ||\n        this.callWith === callingOptions.customphone\n      )\n    );\n  }\n  _hasPhoneNumberChanged() {\n    return (\n      (this.callWith === callingOptions.otherphone &&\n        this._otherPhoneNumbers.indexOf(this.myLocation) === -1) ||\n      (this.callWith === callingOptions.myphone &&\n        this._myPhoneNumbers.indexOf(this.myLocation) === -1)\n    );\n  }\n  @proxify\n  async _warningEmergencyCallingNotAvailable() {\n    if (this.callWith === callingOptions.browser) {\n      this._alert.info({\n        message: callingSettingsMessages.emergencyCallingNotAvailable,\n        ttl: 0,\n      });\n    }\n  }\n\n  get status() {\n    return this.state.status;\n  }\n\n  get ready() {\n    return this.state.status === moduleStatuses.ready;\n  }\n\n  get pending() {\n    return this.state.status === moduleStatuses.pending;\n  }\n\n  get callWith() {\n    return this._storage.getItem(this._callWithStorageKey);\n  }\n\n  get callingMode() {\n    return mapOptionToMode(this.callWith);\n  }\n\n  get callWithOptions() {\n    return this._selectors.callWithOptions();\n  }\n\n  get ringoutPrompt() {\n    return this._storage.getItem(this._ringoutPromptStorageKey);\n  }\n\n  get myLocation() {\n    return this._storage.getItem(this._myLocationStorageKey);\n  }\n\n  get timestamp() {\n    return this._storage.getItem(this._timestampStorageKey);\n  }\n\n  get myPhoneNumbers() {\n    return this._selectors.myPhoneNumbers();\n  }\n\n  get otherPhoneNumbers() {\n    return this._selectors.otherPhoneNumbers();\n  }\n\n  get availableNumbers() {\n    return this._selectors.availableNumbers();\n  }\n\n  get fromNumber() {\n    return this._storage.getItem(this._fromNumberStorageKey);\n  }\n\n  get fromNumbers() {\n    return this._selectors.fromNumbers();\n  }\n\n  @proxify\n  async setData({ callWith, myLocation, ringoutPrompt }, withPrompt) {\n    // TODO validate myLocation\n    this.store.dispatch({\n      type: this.actionTypes.setData,\n      callWith,\n      myLocation,\n      ringoutPrompt,\n      timestamp: Date.now(),\n    });\n    if (withPrompt) {\n      if (this.callWith === callingOptions.softphone) {\n        this._alert.info({\n          message: callingSettingsMessages.saveSuccessWithSoftphone,\n        });\n      } else {\n        this._alert.info({\n          message: callingSettingsMessages.saveSuccess,\n        });\n        this._warningEmergencyCallingNotAvailable();\n      }\n    }\n  }\n}\n"]}