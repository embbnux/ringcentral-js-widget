{"version":3,"sources":["modules/UserGuide/index.js"],"names":["SUPPORTED_LOCALES","UserGuide","deps","dep","optional","auth","locale","storage","webphone","rolesAndPermissions","options","actionTypes","_auth","_locale","_storage","_webphone","_rolesAndPermissions","_reducer","_context","context","_storageKey","_guideReducer","registerReducer","key","reducer","store","subscribe","_onStateChange","pending","ready","loggedIn","dispatch","type","initSuccess","initUserGuide","preLoadImage","resetSuccess","ringSession","_lastRingSession","dismiss","url","resolve","reject","img","Image","src","onload","onerror","guides","_preLoadImage","preLoadImageStatus","locales","keys","sort","map","reduce","prev","curr","forEach","push","updateCarousel","curIdx","entered","playing","firstLogin","loadGuides","state","hasUserGuidePermission","prevGuides","allGuides","resolveGuides","start","currentGuides","currentLocale","length","getItem","carouselState","status","RcModule","proxify"],"mappings":"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","file":"index.js","sourcesContent":["import { contains } from 'ramda';\nimport RcModule from '../../lib/RcModule';\nimport proxify from '../../lib/proxy/proxify';\nimport { Module } from '../../lib/di';\nimport actionTypes from './actionTypes';\nimport getUserGuideReducer, { getGuidesReducer } from './getUserGuideReducer';\n\n/**\n * Support localization\n */\nconst SUPPORTED_LOCALES = {\n  'en-US': 'en-US',\n  'fr-CA': 'fr-CA',\n};\n\n@Module({\n  deps: [\n    'Auth',\n    'Locale',\n    'Storage',\n    'Webphone',\n    'RolesAndPermissions',\n    { dep: 'UserGuideOptions', optional: true }\n  ]\n})\nexport default class UserGuide extends RcModule {\n  constructor({\n    auth,\n    locale,\n    storage,\n    webphone,\n    rolesAndPermissions,\n    ...options\n  }) {\n    super({\n      actionTypes,\n      ...options\n    });\n    this._auth = auth;\n    this._locale = locale;\n    this._storage = storage;\n    this._webphone = webphone;\n    this._rolesAndPermissions = rolesAndPermissions;\n    this._reducer = getUserGuideReducer(this.actionTypes);\n\n    this._context = options.context;\n\n    this._storageKey = 'userGuide';\n    this._guideReducer = getGuidesReducer(this.actionTypes);\n    this._storage.registerReducer({\n      key: this._storageKey,\n      reducer: this._guideReducer,\n    });\n  }\n\n  initialize() {\n    this.store.subscribe(() => this._onStateChange());\n  }\n\n  async _onStateChange() {\n    if (\n      this.pending &&\n      this._auth.ready &&\n      this._locale.ready &&\n      this._storage.ready &&\n      this._rolesAndPermissions.ready &&\n      this._auth.loggedIn\n    ) {\n      this.store.dispatch({\n        type: this.actionTypes.initSuccess,\n      });\n      await this.initUserGuide();\n      await this.preLoadImage();\n    } else if (\n      this.ready && (\n        !this._auth.ready ||\n        !this._locale.ready ||\n        !this._storage.ready ||\n        !this._rolesAndPermissions.ready\n      )\n    ) {\n      this.store.dispatch({\n        type: this.actionTypes.resetSuccess\n      });\n    }\n    // When there is an incoming call,\n    // the guide should be dismissed\n    if (\n      this._webphone.ready &&\n      this._webphone.ringSession &&\n      this._webphone.ringSession !== this._lastRingSession\n    ) {\n      this._lastRingSession = this._webphone.ringSession;\n      this.dismiss();\n    }\n  }\n\n  @proxify\n  async _preLoadImage(url) {\n    await new Promise((resolve, reject) => {\n      const img = new Image();\n      img.src = url;\n      img.onload = resolve;\n      img.onerror = resolve;\n    });\n  }\n\n  @proxify\n  async preLoadImage() {\n    const url = this.guides[0];\n    if (url) {\n      await this._preLoadImage(url);\n    }\n    this.store.dispatch({\n      type: this.actionTypes.preLoadImageStatus,\n    });\n  }\n\n  /**\n   * Using webpack `require.context` to load guides files.\n   * Image files will be ordered by file name ascendingly.\n   * @return {Map<String, Array<URI>>}\n   */\n  resolveGuides() {\n    if (this._context && typeof this._context === 'function') {\n      const locales = Object.keys(SUPPORTED_LOCALES);\n      return this._context.keys().sort()\n        .map(key => this._context(key))\n        .reduce((prev, curr) => {\n          locales.forEach((locale) => {\n            if (!prev[locale]) prev[locale] = [];\n            if (contains(locale, curr)) {\n              prev[locale].push(curr);\n            }\n          });\n          return prev;\n        }, {});\n    }\n    return {};\n  }\n\n  @proxify\n  dismiss() {\n    this.updateCarousel({\n      curIdx: 0, entered: false, playing: false, firstLogin: false\n    });\n  }\n\n  @proxify\n  async loadGuides(guides) {\n    if (guides) {\n      this.store.dispatch({\n        type: this.actionTypes.loadGuides,\n        guides\n      });\n    }\n  }\n\n  @proxify\n  async updateCarousel({\n    curIdx, entered, playing, firstLogin = this.state.firstLogin\n  }) {\n    this.store.dispatch({\n      type: this.actionTypes.updateCarousel,\n      curIdx,\n      entered,\n      playing,\n      firstLogin\n    });\n  }\n\n  @proxify\n  async initUserGuide() {\n    if (!this._rolesAndPermissions.hasUserGuidePermission) return;\n    // eslint-disable-next-line\n    const prevGuides = this.allGuides;\n    const guides = this.resolveGuides();\n    // Determine if it needs to be displayed when first log in,\n    // the principles behind this is to use webpack's file hash,\n    // i.e. if any of the guide files is changed, the file name hash\n    // will be changed as well, in this case, it will be displayed.\n    await this.loadGuides(guides);\n    if (JSON.stringify(guides) !== JSON.stringify(prevGuides)) {\n      this.start({ firstLogin: true });\n    }\n  }\n\n  @proxify\n  async start({ firstLogin = false } = {}) {\n    // Start guides only when images are ready\n    this.store.dispatch({\n      type: this.actionTypes.updateCarousel,\n      curIdx: 0,\n      entered: true,\n      playing: true,\n      firstLogin\n    });\n  }\n\n  get guides() {\n    if (!this._locale.ready) return [];\n    if (this.allGuides) {\n      const currentGuides = this.allGuides[this._locale.currentLocale];\n      if (currentGuides && currentGuides.length > 0) return currentGuides;\n      return this.allGuides[SUPPORTED_LOCALES['en-US']] || [];\n    }\n    return [];\n  }\n\n  get allGuides() {\n    if (!this._storage.ready) return null;\n    return this._storage.getItem(this._storageKey);\n  }\n\n  get carouselState() {\n    return this.state.carouselState;\n  }\n\n  get started() {\n    return this.carouselState.entered && this.carouselState.playing;\n  }\n\n  get status() {\n    return this.state.status;\n  }\n\n  get preLoadImageStatus() {\n    return this.state.preLoadImageStatus;\n  }\n}\n"]}