{"version":3,"sources":["modules/ProxyFrameOAuth/index.js"],"names":["DEFAULT_PROXY_RETRY","ProxyFrameOAuth","name","deps","dep","optional","redirectUri","proxyUri","defaultProxyRetry","options","_callbackHandler","origin","data","callbackUri","proxyLoaded","_handleCallbackUri","clearTimeout","_retryTimeoutId","store","dispatch","type","actionTypes","setupOAuth","_createProxyFrame","_proxyFrame","document","createElement","src","style","display","isEdge","window","navigator","userAgent","indexOf","isIE","test","setAttribute","join","body","appendChild","addEventListener","setTimeout","_retrySetupProxyFrame","_defaultProxyRetry","_uuid","uuid","v4","_proxyUri","_reducer","_loggedIn","_auth","loggedIn","isImplicit","console","log","_createImplicitRefreshTimeout","_clearImplicitRefreshIframe","_implicitRefreshTimeoutId","oAuthReady","proxyRetry","_destroyProxyFrame","removeChild","removeEventListener","setupProxy","destroyOAuth","contentWindow","postMessage","oAuthUri","_implicitRefreshFrame","implictRefreshOAuthUri","_implictitRefreshCallBack","refreshCallbackUri","authData","token","refreshTokenExpiresIn","expiresIn","expireTime","refreshTokenTimeoutTime","parseInt","Date","now","_tabManager","active","_createImplicitRefreshIframe","url","resolve","location","href","encodeURIComponent","btoa","prefix","state","proxyRetryCount","OAuthBase","background","proxify"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;;;;AACA;;;;AACA;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AAEA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAEA,IAAMA,sBAAsB,IAA5B;;IAQqBC,e,WANpB,gBAAO;AACNC,QAAM,OADA;AAENC,QAAM,CACJ,EAAEC,KAAK,cAAP,EAAuBC,UAAU,IAAjC,EADI;AAFA,CAAP,C;;;AAOC,iCAKG;AAAA;;AAAA,gCAJDC,WAIC;AAAA,QAJDA,WAIC,oCAJa,iBAIb;AAAA,6BAHDC,QAGC;AAAA,QAHDA,QAGC,iCAHU,cAGV;AAAA,qCAFDC,iBAEC;AAAA,QAFDA,iBAEC,yCAFmBR,mBAEnB;AAAA,QADES,OACF;AAAA;;AAAA;AAECH;AAFD,OAGIG,OAHJ;;AAAA,UAuDHC,gBAvDG;AAAA,2FAuDgB;AAAA,YAASC,MAAT,SAASA,MAAT;AAAA,YAAiBC,IAAjB,SAAiBA,IAAjB;AAAA;AAAA;AAAA;AAAA;AAAA;AACjB;AACA,oBAAIA,IAAJ,EAAU;AAENC,6BAFM,GAIJD,IAJI,CAENC,WAFM,EAGNC,WAHM,GAIJF,IAJI,CAGNE,WAHM;;AAKR,sBACED,WADF,EAEE;AACA,0BAAKE,kBAAL,CAAwBF,WAAxB;AACD,mBAJD,MAIO,IAAIC,WAAJ,EAAiB;AACtBE,iCAAa,MAAKC,eAAlB;AACA,0BAAKA,eAAL,GAAuB,IAAvB;AACA,0BAAKC,KAAL,CAAWC,QAAX,CAAoB;AAClBC,4BAAM,MAAKC,WAAL,CAAiBC;AADL,qBAApB;AAGD;AACF;;AAlBgB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,OAvDhB;;AAAA;AAAA;AAAA;AAAA;;AAAA,UA2EHC,iBA3EG,GA2EiB,YAAM;AACxB,YAAKC,WAAL,GAAmBC,SAASC,aAAT,CAAuB,QAAvB,CAAnB;AACA,YAAKF,WAAL,CAAiBG,GAAjB,GAAuB,MAAKpB,QAA5B;AACA,YAAKiB,WAAL,CAAiBI,KAAjB,CAAuBC,OAAvB,GAAiC,MAAjC;AACA,UAAMC,SAASC,UAAUA,OAAOC,SAAjB,IAA8BD,OAAOC,SAAP,CAAiBC,SAAjB,CAA2BC,OAA3B,CAAmC,MAAnC,IAA6C,CAAC,CAA3F;AACA,UAAMC,OAAOJ,UAAUA,OAAOC,SAAjB,IAA8B,gBAAgBI,IAAhB,CAAqBL,OAAOC,SAAP,CAAiBC,SAAtC,CAA3C;AACA,UAAI,CAACH,MAAD,IAAW,CAACK,IAAhB,EAAsB;AACpB,cAAKX,WAAL,CAAiBa,YAAjB,CAA8B,SAA9B,EAAyC,CACvC,eADuC,EAEvC,cAFuC,EAGvC,mBAHuC,EAIvC,aAJuC,EAKvCC,IALuC,CAKlC,GALkC,CAAzC;AAMD;AACDb,eAASc,IAAT,CAAcC,WAAd,CAA0B,MAAKhB,WAA/B;AACAO,aAAOU,gBAAP,CAAwB,SAAxB,EAAmC,MAAK/B,gBAAxC;AACA,YAAKO,eAAL,GAAuByB,WAAW,YAAM;AACtC,cAAKC,qBAAL;AACD,OAFsB,EAEpB,MAAKC,kBAFe,CAAvB;AAGD,KA9FE;;AAKD,UAAKC,KAAL,GAAaC,eAAKC,EAAL,EAAb;AACA,UAAKC,SAAL,GAAiB,2BAAYzC,QAAZ,EAAsB,UAAtB,CAAjB;AACA,UAAKqC,kBAAL,GAA0BpC,iBAA1B;;AAEA,UAAKyC,QAAL,GAAgB,yCAA0B,MAAK5B,WAA/B,CAAhB;;AAEA,UAAK6B,SAAL,GAAiB,KAAjB;AAXC;AAYF;;;;qCAEgB;AACf;AACA,UAAI,KAAKC,KAAL,CAAWC,QAAX,KAAwB,KAAKF,SAAjC,EAA4C;AAC1C;AACD;AACD,WAAKA,SAAL,GAAiB,KAAKC,KAAL,CAAWC,QAA5B;AACA,UAAI,KAAKF,SAAL,IAAkB,KAAKC,KAAL,CAAWE,UAAjC,EAA6C;AAC3CC,gBAAQC,GAAR,CAAY,wCAAZ;AACA,aAAKC,6BAAL;AACD;AACD,UAAI,CAAC,KAAKN,SAAN,IAAmB,KAAKC,KAAL,CAAWE,UAAlC,EAA8C;AAC5C,aAAKI,2BAAL;AACA,YAAI,KAAKC,yBAAT,EAAoC;AAClC1C,uBAAa,KAAK0C,yBAAlB;AACD;AACF;AACF;;;;6GAEwBjD,O;;;;;;kLACQA,O;;;AAC/B,oBAAI,KAAK0C,KAAL,CAAWE,UAAX,IAAyB,KAAKF,KAAL,CAAWC,QAAxC,EAAkD;AAChD,uBAAKI,6BAAL;AACD;;;;;;;;;;;;;;;;;;4CA2DqB;AACtB,WAAKvC,eAAL,GAAuB,IAAvB;AACA,UAAI,CAAC,KAAK0C,UAAV,EAAsB;AACpB,aAAKzC,KAAL,CAAWC,QAAX,CAAoB;AAClBC,gBAAM,KAAKC,WAAL,CAAiBuC;AADL,SAApB;AAGA,aAAKC,kBAAL;AACA,aAAKtC,iBAAL;AACD;AACF;;;yCACoB;AACnBE,eAASc,IAAT,CAAcuB,WAAd,CAA0B,KAAKtC,WAA/B;AACA,WAAKA,WAAL,GAAmB,IAAnB;AACAO,aAAOgC,mBAAP,CAA2B,SAA3B,EAAsC,KAAKrD,gBAA3C;AACD;;;;;;;;;AAIC,oBACE,CAAC,KAAKc,WADR,EAEE;AACA,uBAAKN,KAAL,CAAWC,QAAX,CAAoB;AAClBC,0BAAM,KAAKC,WAAL,CAAiB2C;AADL,mBAApB;AAGA,uBAAKzC,iBAAL;AACD;;;;;;;;;;;;;;;;;;;;;;;;AAKD,oBAAI,KAAKC,WAAT,EAAsB;AACpB,sBAAI,KAAKP,eAAT,EAA0B;AACxBD,iCAAa,KAAKC,eAAlB;AACA,yBAAKA,eAAL,GAAuB,IAAvB;AACD;AACD,uBAAK4C,kBAAL;AACA,uBAAK3C,KAAL,CAAWC,QAAX,CAAoB;AAClBC,0BAAM,KAAKC,WAAL,CAAiB4C;AADL,mBAApB;AAGD;;;;;;;;;;;;;;;;;;oCAIa;AACd,UAAI,KAAKN,UAAT,EAAqB;AACnB,aAAKnC,WAAL,CAAiB0C,aAAjB,CAA+BC,WAA/B,CAA2C;AACzCC,oBAAU,KAAKA;AAD0B,SAA3C,EAEG,GAFH;AAGD;AACF;;;mDAE8B;AAAA;;AAC7B,WAAKX,2BAAL;AACA,WAAKY,qBAAL,GAA6B5C,SAASC,aAAT,CAAuB,QAAvB,CAA7B;AACA,WAAK2C,qBAAL,CAA2B1C,GAA3B,GAAiC,KAAK2C,sBAAtC;AACA,WAAKD,qBAAL,CAA2BzC,KAA3B,CAAiCC,OAAjC,GAA2C,MAA3C;AACAJ,eAASc,IAAT,CAAcC,WAAd,CAA0B,KAAK6B,qBAA/B;AACA;AACA,WAAKE,yBAAL,GAAiC,iBAAsB;AAAA,YAAnB5D,MAAmB,SAAnBA,MAAmB;AAAA,YAAXC,IAAW,SAAXA,IAAW;AAAA,YAC7C4D,kBAD6C,GACtB5D,IADsB,CAC7C4D,kBAD6C;;AAErD,YAAIA,sBAAsB,OAAKrB,KAAL,CAAWC,QAArC,EAA+C;AAC7C,iBAAKrC,kBAAL,CAAwByD,kBAAxB,EAA4C,IAA5C;AACA,iBAAKf,2BAAL;AACD;AACF,OAND;AAOA1B,aAAOU,gBAAP,CAAwB,SAAxB,EAAmC,KAAK8B,yBAAxC;AACD;;;kDAE6B;AAC5B,UAAI,KAAKF,qBAAT,EAAgC;AAC9B5C,iBAASc,IAAT,CAAcuB,WAAd,CAA0B,KAAKO,qBAA/B;AACA,aAAKA,qBAAL,GAA6B,IAA7B;AACAtC,eAAOgC,mBAAP,CAA2B,SAA3B,EAAsC,KAAKQ,yBAA3C;AACA,aAAK7D,gBAAL,GAAwB,IAAxB;AACD;AACF;;AAED;;;;oDACgC;AAAA;;AAC9B,UAAI,KAAKgD,yBAAT,EAAoC;AAClC1C,qBAAa,KAAK0C,yBAAlB;AACD;AACD,UAAMe,WAAW,KAAKtB,KAAL,CAAWuB,KAA5B;AACA,UAAMC,wBAAwBF,SAASG,SAAvC;AAL8B,UAMtBC,UANsB,GAMPJ,QANO,CAMtBI,UANsB;;AAO9B,UAAI,CAACF,qBAAD,IAA0B,CAACE,UAA/B,EAA2C;AACzC;AACD;AACD;AACA,UAAIC,0BAA2BC,SAASJ,qBAAT,EAAgC,EAAhC,IAAsC,IAAvC,GAA+C,CAA7E;AACA,UAAIG,0BAA0BE,KAAKC,GAAL,EAA1B,GAAuCJ,UAA3C,EAAuD;AACrDC,kCAA0BD,aAAaG,KAAKC,GAAL,EAAb,GAA0B,IAApD;AACA,YAAIH,0BAA0B,CAA9B,EAAiC;AAC/B;AACD;AACF;AACD,WAAKpB,yBAAL,GAAiChB,WAAW,YAAM;AAChD,YAAI,CAAC,OAAKS,KAAL,CAAWC,QAAhB,EAA0B;AACxB;AACD;AACD,YAAI,OAAK8B,WAAL,IAAoB,CAAC,OAAKA,WAAL,CAAiBC,MAA1C,EAAkD;AAChD,iBAAK3B,6BAAL;AACA;AACD;AACD,eAAK4B,4BAAL;AACA,eAAK1B,yBAAL,GAAiC,IAAjC;AACD,OAVgC,EAU9BoB,uBAV8B,CAAjC;AAWD;;;wBAnKU;AACT,aAAO,iBAAP;AACD;;;wBAEkB;AACjB,aAAOzD,qBAAP;AACD;;;wBAEc;AACb,aAAUgE,cAAIC,OAAJ,CAAYvD,OAAOwD,QAAP,CAAgBC,IAA5B,EAAkC,KAAKxC,SAAvC,CAAV,cAAoEyC,mBAAmBC,KAAK,KAAK7C,KAAV,CAAnB,CAApE,gBAAmH4C,mBAAmB,KAAKE,MAAxB,CAAnH;AACD;;;wBAEqB;AACpB,aAAO,KAAKC,KAAL,CAAWC,eAAlB;AACD;;;EA3D0CC,mB,gEAqH1CC,oB,+JAYAA,oB,kKAcAC,iB;kBA/IkB/F,e","file":"index.js","sourcesContent":["import background from 'ringcentral-integration/lib/background';\nimport proxify from 'ringcentral-integration/lib/proxy/proxify';\nimport { Module } from 'ringcentral-integration/lib/di';\nimport ensureExist from 'ringcentral-integration/lib/ensureExist';\nimport url from 'url';\nimport uuid from 'uuid';\nimport actionTypes from './actionTypes';\nimport getProxyFrameOAuthReducer from './getProxyFrameOAuthReducer';\n\nimport OAuthBase from '../../lib/OAuthBase';\n\nconst DEFAULT_PROXY_RETRY = 5000;\n\n@Module({\n  name: 'OAuth',\n  deps: [\n    { dep: 'OAuthOptions', optional: true },\n  ],\n})\nexport default class ProxyFrameOAuth extends OAuthBase {\n  constructor({\n    redirectUri = './redirect.html',\n    proxyUri = './proxy.html',\n    defaultProxyRetry = DEFAULT_PROXY_RETRY,\n    ...options\n  }) {\n    super({\n      redirectUri,\n      ...options,\n    });\n    this._uuid = uuid.v4();\n    this._proxyUri = ensureExist(proxyUri, 'proxyUri');\n    this._defaultProxyRetry = defaultProxyRetry;\n\n    this._reducer = getProxyFrameOAuthReducer(this.actionTypes);\n\n    this._loggedIn = false;\n  }\n\n  _onStateChange() {\n    super._onStateChange();\n    if (this._auth.loggedIn === this._loggedIn) {\n      return;\n    }\n    this._loggedIn = this._auth.loggedIn;\n    if (this._loggedIn && this._auth.isImplicit) {\n      console.log('new login, start refresh token timeout');\n      this._createImplicitRefreshTimeout();\n    }\n    if (!this._loggedIn && this._auth.isImplicit) {\n      this._clearImplicitRefreshIframe();\n      if (this._implicitRefreshTimeoutId) {\n        clearTimeout(this._implicitRefreshTimeoutId);\n      }\n    }\n  }\n\n  async _handleCallbackUri(options) {\n    await super._handleCallbackUri(options);\n    if (this._auth.isImplicit && this._auth.loggedIn) {\n      this._createImplicitRefreshTimeout();\n    }\n  }\n\n  get name() {\n    return 'proxyFrameOAuth';\n  }\n\n  get _actionTypes() {\n    return actionTypes;\n  }\n\n  get proxyUri() {\n    return `${url.resolve(window.location.href, this._proxyUri)}?hash=${encodeURIComponent(btoa(this._uuid))}&prefix=${encodeURIComponent(this.prefix)}`;\n  }\n\n  get proxyRetryCount() {\n    return this.state.proxyRetryCount;\n  }\n\n  _callbackHandler = async ({ origin, data }) => {\n    // TODO origin check\n    if (data) {\n      const {\n        callbackUri,\n        proxyLoaded,\n      } = data;\n      if (\n        callbackUri\n      ) {\n        this._handleCallbackUri(callbackUri);\n      } else if (proxyLoaded) {\n        clearTimeout(this._retryTimeoutId);\n        this._retryTimeoutId = null;\n        this.store.dispatch({\n          type: this.actionTypes.setupOAuth,\n        });\n      }\n    }\n  }\n  _createProxyFrame = () => {\n    this._proxyFrame = document.createElement('iframe');\n    this._proxyFrame.src = this.proxyUri;\n    this._proxyFrame.style.display = 'none';\n    const isEdge = window && window.navigator && window.navigator.userAgent.indexOf('Edge') > -1;\n    const isIE = window && window.navigator && /MSIE|Trident/i.test(window.navigator.userAgent);\n    if (!isEdge && !isIE) {\n      this._proxyFrame.setAttribute('sandbox', [\n        'allow-scripts',\n        'allow-popups',\n        'allow-same-origin',\n        'allow-forms',\n      ].join(' '));\n    }\n    document.body.appendChild(this._proxyFrame);\n    window.addEventListener('message', this._callbackHandler);\n    this._retryTimeoutId = setTimeout(() => {\n      this._retrySetupProxyFrame();\n    }, this._defaultProxyRetry);\n  }\n  _retrySetupProxyFrame() {\n    this._retryTimeoutId = null;\n    if (!this.oAuthReady) {\n      this.store.dispatch({\n        type: this.actionTypes.proxyRetry,\n      });\n      this._destroyProxyFrame();\n      this._createProxyFrame();\n    }\n  }\n  _destroyProxyFrame() {\n    document.body.removeChild(this._proxyFrame);\n    this._proxyFrame = null;\n    window.removeEventListener('message', this._callbackHandler);\n  }\n\n  @background\n  async setupOAuth() {\n    if (\n      !this._proxyFrame\n    ) {\n      this.store.dispatch({\n        type: this.actionTypes.setupProxy,\n      });\n      this._createProxyFrame();\n    }\n  }\n\n  @background\n  async destroyOAuth() {\n    if (this._proxyFrame) {\n      if (this._retryTimeoutId) {\n        clearTimeout(this._retryTimeoutId);\n        this._retryTimeoutId = null;\n      }\n      this._destroyProxyFrame();\n      this.store.dispatch({\n        type: this.actionTypes.destroyOAuth,\n      });\n    }\n  }\n\n  @proxify\n  openOAuthPage() {\n    if (this.oAuthReady) {\n      this._proxyFrame.contentWindow.postMessage({\n        oAuthUri: this.oAuthUri,\n      }, '*');\n    }\n  }\n\n  _createImplicitRefreshIframe() {\n    this._clearImplicitRefreshIframe();\n    this._implicitRefreshFrame = document.createElement('iframe');\n    this._implicitRefreshFrame.src = this.implictRefreshOAuthUri;\n    this._implicitRefreshFrame.style.display = 'none';\n    document.body.appendChild(this._implicitRefreshFrame);\n    // eslint-disable-next-line\n    this._implictitRefreshCallBack = ({ origin, data }) => {\n      const { refreshCallbackUri } = data;\n      if (refreshCallbackUri && this._auth.loggedIn) {\n        this._handleCallbackUri(refreshCallbackUri, true);\n        this._clearImplicitRefreshIframe();\n      }\n    };\n    window.addEventListener('message', this._implictitRefreshCallBack);\n  }\n\n  _clearImplicitRefreshIframe() {\n    if (this._implicitRefreshFrame) {\n      document.body.removeChild(this._implicitRefreshFrame);\n      this._implicitRefreshFrame = null;\n      window.removeEventListener('message', this._implictitRefreshCallBack);\n      this._callbackHandler = null;\n    }\n  }\n\n  // create a time out to refresh implicit flow token\n  _createImplicitRefreshTimeout() {\n    if (this._implicitRefreshTimeoutId) {\n      clearTimeout(this._implicitRefreshTimeoutId);\n    }\n    const authData = this._auth.token;\n    const refreshTokenExpiresIn = authData.expiresIn;\n    const { expireTime } = authData;\n    if (!refreshTokenExpiresIn || !expireTime) {\n      return;\n    }\n    // set refresh time to (token exposre time) / 3\n    let refreshTokenTimeoutTime = (parseInt(refreshTokenExpiresIn, 10) * 1000) / 3;\n    if (refreshTokenTimeoutTime + Date.now() > expireTime) {\n      refreshTokenTimeoutTime = expireTime - Date.now() - 5000;\n      if (refreshTokenTimeoutTime < 0) {\n        return;\n      }\n    }\n    this._implicitRefreshTimeoutId = setTimeout(() => {\n      if (!this._auth.loggedIn) {\n        return;\n      }\n      if (this._tabManager && !this._tabManager.active) {\n        this._createImplicitRefreshTimeout();\n        return;\n      }\n      this._createImplicitRefreshIframe();\n      this._implicitRefreshTimeoutId = null;\n    }, refreshTokenTimeoutTime);\n  }\n}\n"]}