{"version":3,"sources":["lib/messageHelper/index.js"],"names":["filterNumbers","messageIsDeleted","messageIsTextMessage","messageIsFax","messageIsVoicemail","messageIsAcceptable","getMessageType","getMyNumberFromMessage","uniqueRecipients","getRecipientNumbersFromMessage","getRecipients","getNumbersFromMessage","sortByDate","sortSearchResults","getVoicemailAttachment","getFaxAttachment","getMMSAttachment","getConversationId","sortByCreationTime","normalizeRecord","messageIsUnread","numbers","filterNumber","filter","number","phoneNumber","extensionNumber","message","availability","type","messageTypes","fax","voiceMail","messageStatus","text","myExtensionNumber","direction","from","pager","myNumber","to","find","length","recipients","recipientMap","forEach","recipient","key","fromRecipients","sms","allRecipients","concat","push","contacts","slice","correspondents","contact","myPhoneLength","self","inbound","fromField","Array","isArray","toField","a","b","ta","Date","creationTime","getTime","tb","matchOrder","accessToken","attachment","attachments","duration","vmDuration","uri","decodeURIComponent","record","conversationId","conversation","id","toString","newRecord","lastModifiedTime","readStatus"],"mappings":"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","file":"index.js","sourcesContent":["import messageTypes from '../../enums/messageTypes';\nimport removeUri from '../../lib/removeUri';\n\nexport function filterNumbers(numbers, filterNumber) {\n  return numbers.filter((number) => {\n    if (filterNumber.phoneNumber) {\n      return filterNumber.phoneNumber !== number.phoneNumber;\n    }\n    return filterNumber.extensionNumber !== number.extensionNumber;\n  });\n}\n\nexport function messageIsDeleted(message) {\n  return message.availability === 'Deleted' || message.availability === 'Purged';\n}\n\nexport function messageIsTextMessage(message) {\n  return (message.type !== messageTypes.fax && message.type !== messageTypes.voiceMail);\n}\n\nexport function messageIsFax(message) {\n  return (message.type === messageTypes.fax);\n}\n\nexport function messageIsVoicemail(message) {\n  return (message.type === messageTypes.voiceMail);\n}\n\nexport function messageIsAcceptable(message) {\n  // do not show submitted faxes or sending failed faxes now\n  // do not show deleted messages\n  return (message.type !== messageTypes.fax || (message.messageStatus !== 'Queued' && message.messageStatus !== 'SendingFailed')) &&\n    (!messageIsDeleted(message));\n}\n\nexport function getMessageType(message) {\n  if (messageIsTextMessage(message)) {\n    return messageTypes.text;\n  } else if (messageIsVoicemail(message)) {\n    return messageTypes.voiceMail;\n  } else if (messageIsFax(message)) {\n    return messageTypes.fax;\n  }\n  return null;\n}\n\nexport function getMyNumberFromMessage({ message, myExtensionNumber }) {\n  if (!message) {\n    return null;\n  }\n  if (message.direction === 'Outbound') {\n    return message.from;\n  }\n  if (message.type === messageTypes.pager) {\n    const myNumber = message.to.find(number => (\n      number.extensionNumber === myExtensionNumber\n    ));\n    if (myNumber) {\n      return myNumber;\n    }\n    return { extensionNumber: myExtensionNumber };\n  }\n  return message.to && message.to.length >= 0 && message.to[0];\n}\n\nexport function uniqueRecipients(recipients, filter = () => true) {\n  const recipientMap = {};\n  recipients.forEach((recipient) => {\n    if (filter(recipient)) {\n      const key = recipient.extensionNumber || recipient.phoneNumber;\n      recipientMap[key] = recipient;\n    }\n  });\n  return Object.values(recipientMap);\n}\n\nexport function getRecipientNumbersFromMessage({ message, myNumber }) {\n  if (!message) {\n    return [];\n  }\n  const fromRecipients = (message.from && [message.from]) || [];\n  if (message.type === messageTypes.sms) {\n    if (message.direction === 'Outbound') {\n      return message.to;\n    }\n    return fromRecipients;\n  }\n  const allRecipients = fromRecipients.concat(message.to);\n  const recipients = filterNumbers(allRecipients, myNumber);\n  if (recipients.length === 0) {\n    recipients.push(myNumber);\n  }\n  return uniqueRecipients(recipients);\n}\n\nexport function getRecipients({ message, myExtensionNumber }) {\n  const myNumber = getMyNumberFromMessage({\n    message,\n    myExtensionNumber,\n  });\n  return getRecipientNumbersFromMessage({\n    message,\n    myNumber,\n  });\n}\n\nexport function getNumbersFromMessage({ extensionNumber, message }) {\n  if (!message) {\n    return {};\n  }\n  if (message.type === messageTypes.pager) {\n    // It is safer and simpler to just put all known contacts into array and filter self out\n    const contacts = (message.to && message.to.slice()) || [];\n    if (message.from) contacts.push(message.from);\n    const correspondents = uniqueRecipients(contacts,\n      contact => contact.extensionNumber !== extensionNumber\n    );\n    // to support send message to myself.\n    if (correspondents && correspondents.length === 0) {\n      const myPhoneLength =\n        contacts.filter(contact => contact.extensionNumber === extensionNumber).length;\n      if (myPhoneLength > 0 && contacts.length === myPhoneLength) {\n        correspondents.push({\n          extensionNumber,\n        });\n      }\n    }\n    return {\n      self: {\n        extensionNumber\n      },\n      correspondents: correspondents || [],\n    };\n  }\n\n  const inbound = message.direction === 'Inbound';\n  const fromField = (\n    message.from && (Array.isArray(message.from) ? message.from : [message.from])\n  ) || [];\n  const toField = (\n    message.to && (Array.isArray(message.to) ? message.to : [message.to])\n  ) || [];\n  if (inbound) {\n    return {\n      self: toField[0],\n      correspondents: fromField,\n    };\n  }\n  return {\n    self: fromField[0],\n    correspondents: toField,\n  };\n}\n\nexport function sortByDate(a, b) {\n  const ta = new Date(a.creationTime).getTime();\n  const tb = new Date(b.creationTime).getTime();\n  return tb - ta;\n}\n\nexport function sortSearchResults(a, b) {\n  if (a.matchOrder === b.matchOrder) return sortByDate(a, b);\n  return a.matchOrder > b.matchOrder ? 1 : -1;\n}\n\nexport function getVoicemailAttachment(message, accessToken) {\n  const attachment = message.attachments && message.attachments[0];\n  if (!attachment) {\n    return { duration: 0 };\n  }\n  const duration = attachment.vmDuration;\n  const uri = `${attachment.uri}?access_token=${decodeURIComponent(accessToken)}`;\n  return {\n    duration,\n    uri,\n  };\n}\nexport function getFaxAttachment(message, accessToken) {\n  const attachment = message.attachments && message.attachments[0];\n  if (!attachment) {\n    return {};\n  }\n  const uri = `${attachment.uri}?access_token=${decodeURIComponent(accessToken)}`;\n  return {\n    uri\n  };\n}\nexport function getMMSAttachment(message, accessToken) {\n  if (!message.attachments || message.attachments.length === 0) {\n    return null;\n  }\n  const attachment = message.attachments.find(\n    a => a.type === 'MmsAttachment'\n  );\n  if (!attachment) {\n    return null;\n  }\n  const uri = `${attachment.uri}?access_token=${decodeURIComponent(accessToken)}`;\n  return {\n    ...attachment,\n    uri\n  };\n}\n\nexport function getConversationId(record) {\n  const conversationId = (record.conversation && record.conversation.id) || record.id;\n  return conversationId.toString();\n}\n\nexport function sortByCreationTime(a, b) {\n  if (a.creationTime === b.creationTime) return 0;\n  return (a.creationTime > b.creationTime ? -1 : 1);\n}\n\nexport function normalizeRecord(record) {\n  const newRecord = removeUri(record);\n  const conversationId = getConversationId(record);\n  delete newRecord.conversation;\n  return {\n    ...newRecord,\n    creationTime: (new Date(record.creationTime)).getTime(),\n    lastModifiedTime: (new Date(record.lastModifiedTime)).getTime(),\n    conversationId,\n  };\n}\n\nexport function messageIsUnread(message) {\n  return (\n    message.direction === 'Inbound' &&\n    message.readStatus !== 'Read' &&\n    !messageIsDeleted(message)\n  );\n}\n"]}